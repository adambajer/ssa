<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Výpadek signálu!</title>
  <style>
    body {
      background: #8c0014;
      color: white;
      text-align: center;
      font-family: sans-serif;
      padding: 10vh 5vw;
      transition: background 1s ease;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 0.5em;
    }

    .signal-bars {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      height: 50px;
      margin: 20px auto;
    }

    .bar {
      width: 10px;
      margin: 0 3px;
      background-color: #444;
      animation: signalAnim 1s infinite;
      border-radius: 3px;
    }

    .bar:nth-child(1) { height: 10px; animation-delay: 0s; }
    .bar:nth-child(2) { height: 20px; animation-delay: 0.1s; }
    .bar:nth-child(3) { height: 30px; animation-delay: 0.2s; }
    .bar:nth-child(4) { height: 40px; animation-delay: 0.3s; }

    @keyframes signalAnim {
      0%, 100% { opacity: 0.3; transform: scaleY(0.5); }
      50% { opacity: 1; transform: scaleY(1.2); }
    }

    .info {
      margin-top: 20px;
      font-size: 1.1em;
      color: #ccc;
    }

    .online {
      background: #003300;
    }

    .online h1 {
      color: #90ee90;
    }

    .online .bar {
      background-color: limegreen;
      animation: none;
      opacity: 1;
    }
  </style>
</head>
<body>
  <h1 id="status">Není signál!</h1>
  <div class="signal-bars">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>
  <div class="info">
    <div>Od: <span id="startTime">–</span></div><br>
    <div>Trvá: <span id="duration">0 s</span></div>
  </div>

  <script>
    const CHECK_INTERVAL = 1000;
    let reloaded = false;
    const startTimestamp = new Date();
    const startTimeEl = document.getElementById('startTime');
    const durationEl = document.getElementById('duration');
    const statusEl = document.getElementById('status');

    function formatTime(date) {
      return date.toLocaleTimeString('cs-CZ');
    }

    function safeSpeak(text) {
      if (!window.speechSynthesis) return;
      window.speechSynthesis.cancel(); // přeruší předchozí výstup
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'cs-CZ';
      utter.rate = 1;
      window.speechSynthesis.speak(utter);
    }

    function log(msg) {
      console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);
    }

    // Zahájení výpadku
    startTimeEl.textContent = formatTime(startTimestamp);
    safeSpeak('Varování systému, zaznamenán výpadek signálu.');
    safeSpeak('Nouzový režim spuštěn. Čekám na obnovu spojení.');
    log('Výpadek signálu zahájen.');

    // Aktualizace trvání
    setInterval(() => {
      const now = new Date();
      const seconds = Math.floor((now - startTimestamp) / 1000);
      durationEl.textContent = `${seconds} s`;
    }, 1000);

    // Kontrola připojení
    setInterval(async () => {
      if (reloaded) return;
      try {
        const res = await fetch('/ssa/ping.txt', { cache: 'no-cache' });
        if (res.ok) {
          const now = new Date();
          const duration = Math.floor((now - startTimestamp) / 1000);
          const summary = `Signál obnoven v ${formatTime(now)}. Výpadek trval ${duration} sekund.`;

          log(summary);
          safeSpeak(summary);

          document.body.classList.add('online');
          statusEl.textContent = 'Signál obnoven! Načítám…';

          reloaded = true;
          setTimeout(() => {
            location.href = '/ssa/';
          }, 4000); // čas na dočtení
        }
      } catch {
        // stále offline
      }
    }, CHECK_INTERVAL);
  </script>
</body>
</html>
