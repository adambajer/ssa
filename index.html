<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>SSA</title>
  <meta name="theme-color" content="#1976D2">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/svg+xml" href="./fav.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" href="./fav.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="manifest" href="./site.webmanifest" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
    crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap container-fluid ">
    <div class="a1 border-bottom mb-2 ">
      <div class="tabs">
        <div class="tabs d-flex flex-wrap align-items-center">
          <!-- Tab buttons budou dynamicky doplnƒõny -->
          <button class="tab-add-btn btn btn-sm " id="add-tab-btn" title="P≈ôidat z√°lo≈æku">+</button>
          <div class="d-flex justify-content-between align-items-center">
            <div class="dropdown">
              <button class="btn btn-link p-2 text-secondary" type="button" id="menuDropdown" data-bs-toggle="dropdown"
                aria-expanded="false" title="Hlavn√≠ menu">
                <span class="material-icons">menu</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="menuDropdown">
                <li><button class="dropdown-item d-flex align-items-center" id="import-tab"
                    title="Otev≈ô√≠t ulo≈æenou z√°lo≈æku"><span
                      class="material-icons me-2">folder_open</span>Otev≈ô√≠t</button></li>
                <li><button class="dropdown-item d-flex align-items-center" id="export-tab" title="Ulo≈æit z√°lo≈æku"><span
                      class="material-icons me-2">save</span>Ulo≈æit</button></li>
                <!-- Add this new menu item in the dropdown menu -->
                <li><button class="dropdown-item d-flex align-items-center" id="erase-data-btn"
                    title="Vymazat v≈°echna data">
                    <span class="material-icons me-2">delete_forever</span>Reset
                  </button></li>
                <hr class="dropdown-divider">
                </li>
                <li>
                  <button class="dropdown-item d-flex align-items-center" id="share-btn" title="Sd√≠let">
                    <span class="material-icons me-2">share</span>Sd√≠let
                  </button>
                </li>
                <li><button class="dropdown-item d-flex align-items-center" id="btn-install" hidden
                    title="Instalovat aplikaci"><span
                      class="material-icons me-2">phone_android</span>Instalovat</button>
                </li>
                <li>
                  <button class="dropdown-item d-flex align-items-center" id="toggle-log-btn" title="Zobrazit log">
                    <span class="material-icons me-2">bug_report</span>Log
                  </button>
                </li>
                <li><button class="dropdown-item d-flex align-items-center" id="help-btn"
                    title="Ovl√°d√°n√≠ aplikace"><span class="material-icons me-2">help_outline</span>Ovl√°d√°n√≠</button>
                </li>
                <li><button class="dropdown-item d-flex align-items-center" id="settings-btn"
                    title="Nastaven√≠ aplikace;"><span class="material-icons me-2">settings</span>Nastaven√≠</button>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="recording-container">
          <div class="transcription-button">
         <span id="start-recording" class="shortcut">
              <!-- HTML for the two buttons -->
              <svg version="1.1" viewBox="0 0 210 210" xmlns="http://www.w3.org/2000/svg">
                <g>
                  <path d="m46.2 87.43c-6.23 0-11.28 4.842-11.28 10.82 0 31.98 
                 24.8 58.5 57.06 64.21v26.81h.047a13.02 12.75 0 00-.046.622 
                 13.02 12.75 0 0013.02 12.75 13.02 12.75 0 0013.02-12.75 
                 13.02 12.75 0 00-.016-.622h.016v-26.81c32.27-5.716 
                 57.07-32.23 57.06-64.21 0-5.973-5.05-10.82-11.28-10.82s-11.28 
                 4.842-11.28 10.82c0 24.09-20.95 43.74-47.52 43.74s-47.52-19.65-47.52-43.74
                 c0-5.973-5.05-10.82-11.28-10.82z" fill="#000" />
                  <ellipse cx="92.74" cy="205.8" rx=".757" ry=".076" />
                </g>
                <path class="mikrofon" d="m105 0c-17.49 0-32.36 10.78-38.38 26.07h52.21c2.77 0 
               5 1.973 5 4.425 0 2.451-2.23 4.425-5 4.425h-54.61a41.91 
               41.91 0 00-.482 6.344v.68h55.09c2.77 0 5 1.974 5 4.426 
               0 2.451-2.23 4.425-5 4.425h-55.09v7.025h55.09c2.77 0 
               5 1.973 5 4.425 0 2.451-2.23 4.425-5 4.425h-55.09v29.24c0 
               22.86 18.4 41.26 41.26 41.26s41.26-18.4 41.26-41.26v-54.65c0-22.86-18.4-41.26-41.26-41.26z"
                  stroke-linecap="round" stroke-miterlimit="4.1" fill="#000" ; paint-order="markers fill stroke" />
              </svg>
            </span>
            <button class="text-button">
              <div id="recording-info">
                 <div id="recording-time"></div>
              </div>
            </button>
               
          </div>
        </div>
      </div>
    </div>
    <!-- Modal for displaying the QR code -->
    <div class="modal modal-sm fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="qrModalLabel">Skenuj QR</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
          </div>
          <div class="modal-body">
            <div id="qrcode"></div> <!-- QR code will be generated here -->
          </div>
          <div class="modal-footer">
            <p>https://adambajer.github.io/ssa/</p>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zav≈ô√≠t</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Toast container (prav√Ω spodn√≠ roh) -->
    <div class="position-fixed bottom-0 start-0 p-3" style="z-index: 1080;">
      <!-- Nastaven√≠ (toast) -->
      <div id="settingsToast" class="toast text-bg-light border-0" role="alert" aria-live="assertive" aria-atomic="true"
        data-bs-autohide="false"> <!-- autohide = false  -->
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Nastaven√≠</strong>
          <button type="button" class="btn-close text-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          <div class="mb-3">
            <label for="voiceSelect" class="form-label">Zvolte hlas TTS</label>
            <select id="voiceSelect" class="form-select"></select>
          </div>
          <div class="mb-3">
            <label for="rateRange" class="form-label">
              Rychlost ƒçten√≠: <span id="rateValue">1</span>
            </label>
            <input type="range" id="rateRange" min="0.5" max="10" step="0.1" value="1" class="form-range">
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="ignorePlaying">
            <label class="form-check-label" for="ignorePlaying">
              Ignorovat, pokud ji≈æ prob√≠h√° ƒçten√≠
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="allowMultiple">
            <label class="form-check-label" for="allowMultiple">
              Povolit v√≠ce ƒçten√≠ souƒçasnƒõ
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="launchPadMode">
            <label class="form-check-label" for="launchPadMode">
              Launch-pad vzhled tlaƒç√≠tek
            </label>
          </div>

          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="avatarEnabled">
            <label class="form-check-label" for="avatarEnabled">
              Zobrazit avatar (vpravo dole)
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
      <div id="helpToast" class="toast align-items-start text-bg-light border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Ovl√°d√°n√≠</strong>
          <button type="button" class="btn-close text-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="helpToastBody"></div>
      </div>
    </div>
    <input id="file-input" type="file" accept="application/json" style="display:none" />
    <!-- Toast container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
      <div id="helpToast" class="toast align-items-start text-bg-light border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="toast-header bg-danger text-white">
          <strong class="me-auto">Kl√°vesov√© zkratky</strong>
          <button type="button" class="btn-close text-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="helpToastBody"></div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
    <script>
      const TAB_PREDEFINED = 'predefined';
      let tabsData;
      let customTabs;
       function persist() {
        console.log('[persist] Saving state');
        try {
          localStorage.setItem('customTabs', JSON.stringify(customTabs));
          localStorage.setItem('tabsData', JSON.stringify(tabsData));
          console.log('[persist] OK');
        } catch (e) {
          console.error('[persist] ERR', e);
        }
      }
      function deleteTab(tabId) {
        if (tabId === TAB_PREDEFINED) {
          alert('Tuto z√°lo≈æku nelze smazat');
          return;
        }
        if (!confirm('Opravdu smazat z√°lo≈æku?')) return;
        delete tabsData[tabId];
        const idx = customTabs.findIndex(t => t.id === tabId);
        if (idx > -1) customTabs.splice(idx, 1);
        persist();
        document.querySelector(`.tab-button[data-tab="${tabId}"]`)?.remove();
        document.getElementById(tabId)?.remove();
        activateTab(TAB_PREDEFINED);
      }
      // SSA Application JavaScript
      (() => {
        const toast = new bootstrap.Toast(document.getElementById('helpToast'), {
          autohide: false
        });
        /* === LOG TOAST ======================================================= */
        const logToast = document.createElement('div');
        logToast.id = 'log-toast';
        logToast.className = 'toast shadow';
        Object.assign(logToast.style, {
          position: 'fixed',
          bottom: '1rem',
          right: '0%',
          width: 'auto',
          maxHeight: '60vh', // v√≠c prostoru, ale ne p≈ôes celou v√Ω≈°ku
          overflow: 'hidden', // scrolluje jen body
          display: 'none',
          zIndex: '1100',
          fontFamily: 'monospace',
          resize: 'both', // ‚Üê Umo≈æn√≠ rohov√© ta≈æen√≠ pro zmƒõnu velikosti
        });
        /* ----- Sticky header (drag-handle) ---------------------------------- */
        const header = document.createElement('div');
        header.className = 'toast-header bg-danger text-white';
        header.innerHTML =
          `<strong class="me-auto">Log aplikace</strong>
        <button type="button" class="btn-close text-white" data-bs-dismiss="toast" aria-label="Close"></button>
`;
        Object.assign(header.style, {
          position: 'sticky',
          top: '0',
          cursor: 'move',
        });
        logToast.append(header);
        /* ----- Scrollovateln√© tƒõlo ----------------------------------------- */
        const body = document.createElement('div');
        body.className = 'toast-body pt-0';
        Object.assign(body.style, {
          height: 'calc(60vh - 40px)', // 40 px ‚âà v√Ω≈°ka headeru
          overflowY: 'auto',
          paddingRight: '0.75rem',
        });
        logToast.append(body);
        document.body.append(logToast);
        /* === Viditelnost (polo≈æka ‚ÄûLog panel‚Äú) ============================== */
        document.getElementById('toggle-log-btn')
          .addEventListener('click', () => {
            logToast.style.display =
              logToast.style.display === 'none' ? 'block' : 'none';
          });
        /* Zav≈ô√≠t k≈ô√≠≈ækem */
        header.querySelector('.btn-close')
          .addEventListener('click', () => logToast.style.display = 'none');
        /* === Drag & drop za header ========================================== */
        let dragging = false,
          offX = 0,
          offY = 0;
        header.addEventListener('mousedown', e => {
          dragging = true;
          offX = e.clientX - logToast.offsetLeft;
          offY = e.clientY - logToast.offsetTop;
          e.preventDefault();
        });
        document.addEventListener('mousemove', e => {
          if (!dragging) return;
          logToast.style.left = `${e.clientX - offX}px`;
          logToast.style.top = `${e.clientY - offY}px`;
        });
        document.addEventListener('mouseup', () => dragging = false);
        let menuAwait = false; // ‚áê glob√°ln√≠, viditeln√° pro oba listenery
        /* === P≈ôesmƒõrov√°n√≠ console.log / console.error ======================= */
        let logCounter = 0; // po≈ôadov√© ƒç√≠slo ≈ô√°dku
        const origLog = console.log.bind(console);
        const origErr = console.error.bind(console);
        console.log = (...args) => {
          origLog(...args);
          appendLine('LOG', ...args);
        };
        console.error = (...args) => {
          origErr(...args);
          appendLine('ERROR', ...args);
        };
        function appendLine(type, ...args) {
          const time = new Date().toLocaleTimeString(); // HH:MM:SS
          const msg = args.map(a =>
            typeof a === 'object' ? JSON.stringify(a) : String(a)
          ).join(' ');
          const line = document.createElement('div');
          line.textContent = `[${++logCounter}] ${time} ${type}: ${msg}`;
          if (type === 'ERROR') line.style.color = '#dc3545';
          body.append(line);
          body.scrollTop = body.scrollHeight; // auto-scroll dol≈Ø
        }
        /* -------------------------------------------------------------------- */
        console.log('[App] Initialization start');
        console.log('[App] Version 1.0.0');
        const TAB_PREDEFINED = 'predefined';
        const COLORS = [
          '#B00020', '#007000', '#0033A0', '#800080', '#004D4D',
          '#5D00A0', '#3A3AA0', '#4C7500', '#5C8A00', '#A0522D',
          '#FF4500', '#228B22', '#00688B', '#9932CC', '#CD853F',
          '#8B0000', '#2E8B57', '#4169E1', '#8B4513', '#008B8B',
          '#DC143C', '#556B2F', '#8A2BE2', '#6B8E23', '#D2691E',
          '#B03060', '#483D8B', '#20B2AA', '#A52A2A', '#5F9EA0',
          '#800000', '#7B68EE'
        ];
        let audioCtx, analyser, dataArray, animId, recognition, startTime;
        let keyHandlers = [];
        let visStream = null;          // mikrofon pro vizualizaci 
        const tabsEl = document.querySelector('.tabs');
        const wrapEl = document.querySelector('.wrap');
        const recBtn = document.getElementById('start-recording');
        const recordingTime = document.getElementById('recording-time');
        let isPlaying = false;
        const shareBtn = document.getElementById('share-btn');
        const helpBtn = document.getElementById('help-btn');
        const addBtn = document.getElementById('add-tab-btn');
        const impBtn = document.getElementById('import-tab');
        const expBtn = document.getElementById('export-tab');
        const delBtn = document.getElementById('delete-tab');
        const eraseBtn = document.getElementById('erase-data-btn');
        const fileInput = document.getElementById('file-input');
        const installBtn = document.getElementById('btn-install');
        customTabs = JSON.parse(localStorage.getItem('customTabs') || '[]');
        tabsData = JSON.parse(localStorage.getItem('tabsData') || '{}');
        let isRecording = false;
        let voices = [];
        const settings = {
          voiceURI: '',
          rate: 1,
          ignorePlaying: false,
          allowMultiple: false,
          launchPad: false, // <-- nov√° volba
          avatarEnabled: false
        };
        /* ---------- SETTINGS PERSISTENCE ---------------------------------- */
        function saveSettings() {
          localStorage.setItem('voiceURI', settings.voiceURI);
          localStorage.setItem('rate', settings.rate);
          localStorage.setItem('ignorePlaying', settings.ignorePlaying);
          localStorage.setItem('allowMultiple', settings.allowMultiple);
          localStorage.setItem('launchPad', settings.launchPad);
          localStorage.setItem('avatarEnabled', settings.avatarEnabled);
        }
        function loadSettings() {
          settings.voiceURI = localStorage.getItem('voiceURI') || settings.voiceURI;
          settings.rate = parseFloat(localStorage.getItem('rate') || settings.rate);
          settings.ignorePlaying = JSON.parse(localStorage.getItem('ignorePlaying') || settings.ignorePlaying);
          settings.allowMultiple = JSON.parse(localStorage.getItem('allowMultiple') || settings.allowMultiple);
          settings.launchPad = JSON.parse(localStorage.getItem('launchPad') || settings.launchPad);
          settings.avatarEnabled = JSON.parse(localStorage.getItem('avatarEnabled') || settings.avatarEnabled);
        }
        function initSettings() {
          const select = document.getElementById('voiceSelect');
          const rateRange = document.getElementById('rateRange');
          const rateValue = document.getElementById('rateValue');
          const ignoreChk = document.getElementById('ignorePlaying');
          const multiChk = document.getElementById('allowMultiple');
          const padChk = document.getElementById('launchPadMode');
          const avatarChk = document.getElementById('avatarEnabled');
          padChk.checked = settings.launchPad;
          function populateCzechVoices() {
  voices = speechSynthesis.getVoices() || [];

  // jen ƒçesk√© hlasy
  const cz = voices.filter(v => (v.lang || "").toLowerCase().startsWith("cs"));

  select.innerHTML = "";

  if (!cz.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "≈Ω√°dn√Ω ƒçesk√Ω hlas nenalezen (doinstaluj ƒçe≈°tinu ve Windows/Edge)";
    select.appendChild(opt);
    select.disabled = true;
    settings.voiceURI = "";   // aby to nebylo na neexistuj√≠c√≠
    saveSettings();
    return;
  }

  select.disabled = false;

  cz.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} (${v.lang})` + (v.default ? " ‚òÖ" : "");
    select.appendChild(opt);
  });

  // vyber ulo≈æen√Ω, jinak prvn√≠ ƒçesk√Ω
  const saved = settings.voiceURI;
  const exists = cz.some(v => v.voiceURI === saved);
  select.value = exists ? saved : cz[0].voiceURI;

  if (!exists) {
    settings.voiceURI = select.value;
    saveSettings();
  }
}
 populateCzechVoices();

// d≈Øle≈æit√©: hlasy se ƒçasto naƒç√≠taj√≠ asynchronnƒõ
speechSynthesis.addEventListener("voiceschanged", populateCzechVoices);
select.addEventListener("change", () => {
  settings.voiceURI = select.value;
  saveSettings();
});

          const settingsToast = new bootstrap.Toast(
            document.getElementById('settingsToast'), {
            autohide: false
          } // trvale otev≈ôen√©, dokud ho u≈æivatel nezav≈ôe
          );
          /* select hlasu */
          select.value = settings.voiceURI;
          select.addEventListener('change', () => {
            settings.voiceURI = select.value;
            saveSettings();
          });
          /* rychlost */
          rateRange.value = settings.rate;
          rateValue.textContent = settings.rate;
          rateRange.addEventListener('input', () => {
            settings.rate = parseFloat(rateRange.value);
            rateValue.textContent = settings.rate;
            saveSettings();
          });
          /* ignore / multiple */
          ignoreChk.checked = settings.ignorePlaying;
          multiChk.checked = settings.allowMultiple;
          ignoreChk.addEventListener('change', () => {
            settings.ignorePlaying = ignoreChk.checked;
            saveSettings();
          });
          multiChk.addEventListener('change', () => {
            settings.allowMultiple = multiChk.checked;
            saveSettings();
          });
          /* launch-pad vzhled */
          padChk.checked = settings.launchPad;
          padChk.addEventListener('change', () => {
            settings.launchPad = padChk.checked;
            renderAllButtons();
            saveSettings();
          });
          /* avatar */
          avatarChk.checked = settings.avatarEnabled;
          window.AvatarDock?.setEnabled?.(settings.avatarEnabled);
          avatarChk.addEventListener('change', () => {
            settings.avatarEnabled = avatarChk.checked;
            window.AvatarDock?.setEnabled?.(settings.avatarEnabled);
            saveSettings();
          });
          document.getElementById('settings-btn')
            .addEventListener('click', () => settingsToast.show());
        }
        // Override localStorage
        (function () {
          const oSet = Storage.prototype.setItem,
            oRm = Storage.prototype.removeItem,
            oClr = Storage.prototype.clear;
          Storage.prototype.setItem = function (k, v) {
            console.log('[LS] setItem', k, v);
            try {
              oSet.apply(this, [k, v]);
              console.log('[LS] setItem OK', k);
            } catch (e) {
              console.error('[LS] setItem ERR', k, e);
            }
          };
          Storage.prototype.removeItem = function (k) {
            console.log('[LS] removeItem', k);
            try {
              oRm.apply(this, [k]);
              console.log('[LS] removeItem OK', k);
            } catch (e) {
              console.error('[LS] removeItem ERR', k, e);
            }
          };
          Storage.prototype.clear = function () {
            console.log('[LS] clear');
            try {
              oClr.apply(this);
              console.log('[LS] clear OK');
            } catch (e) {
              console.error('[LS] clear ERR', e);
            }
          };
        })();
        function speak(text, cb) {
          if (settings.ignorePlaying && speechSynthesis.speaking) return;
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = 'cs-CZ';
          utter.rate = settings.rate;
          const voice = voices.find(v => v.voiceURI === settings.voiceURI);
          if (voice) utter.voice = voice;

          utter.onstart = () => {
            if (!settings.allowMultiple) isPlaying = true;
            if (settings.avatarEnabled) {
              window.AvatarDock?.bubbleShow?.(text);
              window.AvatarDock?.talk?.(true);
              window.AvatarDock?.react?.(text);
              window.AvatarDock?.lipsyncText?.(text, utter.rate || 1);
            }
          };

          utter.onboundary = (e) => {
            // Podpora se li≈°√≠ podle prohl√≠≈æeƒçe/hlasu. Kdy≈æ je k dispozici charIndex,
            // odkr√Ωv√°me text v bublinƒõ pr≈Øbƒõ≈ænƒõ.
            if (!settings.avatarEnabled) return;
            if (typeof e?.charIndex === 'number') {
              window.AvatarDock?.bubbleProgress?.(text, e.charIndex);
            }
          };

          const done = () => {
            if (settings.avatarEnabled) {
              window.AvatarDock?.lipsyncStop?.();
              window.AvatarDock?.talk?.(false);
              window.AvatarDock?.bubbleHide?.();
            }
            if (!settings.allowMultiple) isPlaying = false;
            cb?.();
          };

          utter.onend = done;
          utter.onerror = done;

          speechSynthesis.speak(utter);

          // Pokud je multiple povoleno, nenech flag "isPlaying" br√°nit dal≈°√≠m
          if (settings.allowMultiple) isPlaying = false;
        }
        function clearKeyHandlers() {
          keyHandlers.forEach(h => document.removeEventListener('keydown', h));
          keyHandlers = [];
        }
        function registerKeyHandlers(tabId) {
          clearKeyHandlers();
          const container = document.querySelector(`#${tabId} .tab-content-body`);
          if (!container) return;
          // Najdi v≈°echna transcription-button tlaƒç√≠tka kromƒõ nahr√°vac√≠ho
          const wraps = Array.from(container.querySelectorAll('.transcription-button'))
            .filter(wrap => !wrap.closest('#recording-container'));
          // Odstra≈à star√© shortcuty
          wraps.forEach(wrap => {
            const old = wrap.querySelector('.shortcut');
            if (old) old.remove();
          });
          // Nov√© shortcuty A, B, C, ...
          wraps.forEach((wrap, i) => {
            const btn = wrap.querySelector('button');
            if (!btn) return;
            const key = String.fromCharCode(65 + i); // A, B, C...
            // P≈ôidej nov√Ω vizu√°ln√≠ label
            const lbl = document.createElement('span');
            lbl.className = 'shortcut';
            lbl.textContent = key;
            Object.assign(lbl.style, {
              backgroundColor: wrap.style.borderColor,
              color: '#fff',
            });
            wrap.prepend(lbl);
            // Handler pro dan√Ω kl√≠ƒç
            const handler = e => {
              if (
                !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) &&
                e.key.toUpperCase() === key
              ) {
                btn.click();
              }
            };
            document.addEventListener('keydown', handler);
            keyHandlers.push(handler);
          });
          // üéô Mikrofonn√≠ tlaƒç√≠tko ‚Äì reaguje na kl√°vesu Z
          const recButton = document.getElementById('start-recording');
          if (recButton) {
            const handler = e => {
              if (
                !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) &&
                e.key.toUpperCase() === 'Z'
              ) {
                recButton.click();
              }
            };
            document.addEventListener('keydown', handler);
            keyHandlers.push(handler);
          }
        }
        function addButton(text, tabId) {
          console.log(`[addButton] Attempting to add button to tab='${tabId}' with text='${text}'`);
          try {
            const container = document.querySelector(`#${tabId} .tab-content-body`);
            if (!container) throw new Error(`Container for tab '${tabId}' not found`);
            const idx = container.querySelectorAll('.transcription-button').length;
            let color = COLORS[idx % COLORS.length];
            // wrapper div
            const wrap = document.createElement('div');
            wrap.className = 'transcription-button';
            if (settings.launchPad) wrap.classList.add('launch-pad'); // <‚Äî
            wrap.style.borderColor = color;
            // button element
            const btn = document.createElement('button');
            btn.className = 'text-button';
            btn.textContent = text;
            wrap.addEventListener('click', () => {
              if (!settings.allowMultiple && isPlaying) return;
              isPlaying = true;
              // turn the glow on
              wrap.style.transition = 'box-shadow .5s ease-in-out, border .5s ease-in-out';
              wrap.style.boxShadow = `0 0 20px 0 ${color}`; // full glow
              wrap.style.transform = 'all .5s linear'; // keep your pulse
              wrap.classList.add('activated');
              speak(btn.textContent, () => {
                /* ---- WHEN PLAYBACK ENDS ---- */
                wrap.classList.remove('activated');
                // 1. fade the glow to zero ‚Äì the transition makes it smooth
                wrap.style.boxShadow = `0 0 0 0 ${color}`;
                // 2. optional: wipe the inline style after the fade completes
                wrap.addEventListener('transitionend', () => {
                  wrap.style.boxShadow = ''; // back to clean state
                }, {
                  once: true
                });
                isPlaying = false;
              });
            });
            // shortcut label
            const lbl = document.createElement('span');
            lbl.className = 'shortcut';
            lbl.textContent = String.fromCharCode(65 + idx);
            Object.assign(lbl.style, {
              backgroundColor: color,
              color: '#fff',
            });
            wrap.append(lbl, btn);
            //// context menu for edit/delete
            wrap.addEventListener('contextmenu', e => {
              e.preventDefault();
              document.querySelectorAll('.context-menu').forEach(m => m.remove());
              const menu = document.createElement('div');
              menu.className = 'context-menu shadow-sm';
              Object.assign(menu.style, {
                position: 'absolute',
                top: `${e.clientY}px`,
                left: `${e.clientX}px`,
                zIndex: '10000'
              });
              // edit button
              const edit = document.createElement('button');
              edit.textContent = '‚úèÔ∏è Upravit';
              edit.className = 'border-bottom';
              edit.addEventListener('click', () => {
                const nt = prompt('Upravit text:', btn.textContent);
                if (nt) {
                  const btns = Array.from(container.querySelectorAll('.text-button'));
                  const index = btns.indexOf(btn);
                  if (index > -1) {
                    tabsData[tabId][index] = nt;
                    persist();
                    btn.textContent = nt;
                  }
                }
                menu.remove();
                registerKeyHandlers(tabId);
              });
              // delete button
              const del = document.createElement('button');
              del.textContent = 'üóëÔ∏è Smazat';
              del.addEventListener('click', () => {
                const btns = Array.from(container.querySelectorAll('.text-button'));
                const index = btns.indexOf(btn);
                if (index > -1) {
                  tabsData[tabId].splice(index, 1);
                  persist();
                  wrap.remove();
                }
                menu.remove();
                registerKeyHandlers(tabId);
              });
              menu.append(edit, del);
              document.body.append(menu);
              document.addEventListener('click', () => menu.remove(), {
                once: true
              });
            });
            container.append(wrap);
            registerKeyHandlers(tabId);
            appendRecordingButton(tabId); // <-- D≈ÆLE≈ΩIT√â
            console.log(`[addButton] Successfully added button to tab='${tabId}' with text='${text}'`);
          } catch (e) {
            console.error(`[addButton] Failed to add button to tab='${tabId}' with text='${text}'`, e);
          }
        }
        function appendRecordingButton(tabId) {
          const container = document.querySelector(`#${tabId} .tab-content-body`);
          const recorder = document.getElementById('recording-container');
          if (!container || !recorder) return;
          // Odeber z p≈Øvodn√≠ho rodiƒçe
          if (recorder.parentElement !== container) {
            recorder.remove();
          }
          // Zajisti, ≈æe bude viditeln√Ω
          recorder.style.display = 'default';
          // P≈ôipoj ho jako POSLEDN√ç prvek
          container.appendChild(recorder);
        }
        function renderAllButtons() {
          document.querySelectorAll('.transcription-button').forEach(btn => {
            if (settings.launchPad) {
              btn.classList.add('launch-pad');
            } else {
              btn.classList.remove('launch-pad');
            }
            // P≈ôepnut√≠ layoutu na .tab-content-body (p≈ôedek tlaƒç√≠tka)
            const tabContentBody = btn.closest('.tab-content-body');
            if (tabContentBody) {
              if (settings.launchPad) {
                tabContentBody.classList.add('layout-grid');
                tabContentBody.classList.remove('layout-default');
              } else {
                tabContentBody.classList.add('layout-default');
                tabContentBody.classList.remove('layout-grid');
              }
            }
          });
        }
        function createTab(id, name, predef = false) {
          console.log(`[createTab] id='${id}', name='${name}', predef=${predef}`);
          if (document.getElementById(id)) {
            console.log(`[createTab] Tab '${id}' already exists, skipping creation.`);
            return;
          }
          const btn = document.createElement('button');
          btn.className = 'tab-button';
          btn.dataset.tab = id;
          btn.innerHTML = `
  ${name} 
  <span class="tab-close" title="Smazat z√°lo≈æku" onclick="deleteTab('${id}')">&times;</span>
`;
          tabsEl.append(btn);
          tabsEl.append(btn, document.getElementById('add-tab-btn')); // ‚Üê Vlo≈æit P≈òED tlaƒç√≠tko "+"
          const div = document.createElement('div');
          div.className = 'tab-content';
          div.id = id;
          const bd = document.createElement('div');
          bd.className = 'tab-content-body layout-default'; // ‚Üê v√Ωchoz√≠ layout
          div.append(bd);
          wrapEl.append(div);
          const defaults = predef ? [
            'A teƒè mlƒç√≠≈°!',
            'A proƒç?',
            'Proto≈æe v√≠≈°, ≈æe m√°m pravdu!',
            'V≈Øbec to',
            'Nefunguje',
            'Nende to',
            'Zm√°ƒçkni si √©ƒçko',
            'Dej si √©ƒçko',
            'E√©√©√©√©ƒçko!',
            'Nende',
            'Jak nejde?',
            'V≈Øbec nende',
            'Nen√≠ sign√°l',
            'Max nervy!',
            'Co ty?',
            'ƒåus ty piƒço?',
            'Max chutƒõ',
            'Chce≈°?',
            'Chcex!',
            'Nechcex!',
            'Jak v√≠≈°?',
            'V√≠m',
            'Jak semenuje≈°',
            'Na na≈°ulinku',
            'N√° n√°√° ≈°ul√≠√≠√≠nku',
            'Dezasbyls?',
            'D√Ω≈æeju'
          ] : [''];
          const arr = tabsData[id] || defaults;
          console.log(`[createTab] Will add ${arr.length} buttons for tab='${id}'`);
          arr.forEach(t => addButton(t, id));
          appendRecordingButton(id); // ‚¨ÖÔ∏è P≈ôidej sem!
          btn.addEventListener('click', () => activateTab(id));
          console.log(`[createTab] Completed creation for '${id}'`);
        }
        function activateTab(id) {
          console.log('[activateTab]', id);
          if (!isRecording) {
              recordingTime.textContent =
              id === TAB_PREDEFINED ? '' : 'Zaƒçni p≈ôepis';
          }
          document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === id));
          localStorage.setItem('activeTab', id);
          // Move and show/hide recording button
          const recContainer = document.getElementById('recording-container');
          recContainer.classList.add('transcription-button');
          if (id === TAB_PREDEFINED) {
            recContainer.style.display = 'none';
          } else {
            const container = document.querySelector(`#${id} .tab-content-body`);
            if (container && recContainer.parentElement !== container) {
              recContainer.remove();
              container.appendChild(recContainer);
            }
recContainer.style.display = 'flex'; // nebo 'block', podle designu
          }
          if (isRecording) stopRecognition();
          registerKeyHandlers(id);
          console.log('[activateTab] done');
        }
        function initTabs() {
          console.log('[initTabs] start');
          createTab(TAB_PREDEFINED, '1', true);
          customTabs.forEach(t => createTab(t.id, t.name));
          addBtn.addEventListener('click', () => {
            console.log('[initTabs] add click');
            const id = `tab-${customTabs.length + 2}`,
              name = String(customTabs.length + 2);
            customTabs.push({
              id,
              name
            });
            tabsData[id] = [];
            persist();
            createTab(id, name);
            activateTab(id);
          });
          const init = localStorage.getItem('activeTab') || TAB_PREDEFINED;
          console.log('[initTabs] initial', init);
          activateTab(init);
          console.log('[initTabs] done');
          renderAllButtons(); // ‚Üê DOPL≈á TENTO ≈ò√ÅDEK
        }
        function initVoice() {
          console.log('[initVoice]');
          try {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) {
              console.error('[initVoice] SpeechRecognition API not available');
              return;
            }
            try {
              recognition = new SR();
              console.log('[initVoice] SpeechRecognition instance created');
            } catch (e) {
              console.error('[initVoice] Failed to instantiate SpeechRecognition', e);
              return;
            }
            recognition.lang = 'cs-CZ';
            recognition.interimResults = false;
            recognition.continuous = false;
            recognition.onstart = () => {
              console.log('[SR] onstart');
              try {
                recBtn.classList.add('active');
                isRecording = true;
                startTime = Date.now();
                updateRecordingTime();
                /* ADD THIS ‚Üì‚Üì‚Üì */
              } catch (e) {
                console.error('[SR] onstart error', e);
              }
            };
            recognition.onresult = e => {
              console.log('[SR] onresult event', e);
              try {
                const text = e.results[0][0].transcript.trim();
                console.log('[SR] result transcript', text);
                const tabId = localStorage.getItem('activeTab');
                addButton(text, tabId);
                tabsData[tabId] = tabsData[tabId] || [];
                tabsData[tabId].push(text);
                persist();
              } catch (e) {
                console.error('[SR] onresult handling error', e);
              }
            };
            recognition.onerror = e => {
              console.error('[SR] error event', e.error);
            };
            recognition.onend = () => {
              console.log('[SR] onend');
              try {
                recBtn.classList.remove('active');
                 recordingTime.textContent = 'Zaƒçni p≈ôepis';
                const activeTab = localStorage.getItem('activeTab');
               
                recBtn.style.boxShadow = 'none'; // <-- zru≈°√≠ st√≠n √∫plnƒõ
                isRecording = false;
              } catch (e) {
                console.error('[SR] onend error', e);
              }
            };
            const recorder = document.getElementById('recording-container');
            recorder.addEventListener('click', () => {
              const tabId = localStorage.getItem('activeTab');
              if (tabId === TAB_PREDEFINED) {
                alert('Zaƒçni p≈ôepis nen√≠ povoleno');
                return;
              }
              if (isRecording) {
                console.log('[SR] click - stopping recognition');
                try {
                  stopRecognition();
                } catch (e) {
                  console.error('[SR] stopRecognition error', e);
                }
              } else {
                console.log('[SR] click - starting recognition');
                try {
                  startRecognition();
                } catch (e) {
                  console.error('[SR] startRecognition error', e);
                }
              }
            });
            console.log('[initVoice] done');
          } catch (e) {
            console.error('[initVoice] unexpected error', e);
          }
        }
        function startRecognition() {
          console.log('[SR] startRecognition');
          try {
            recognition.start();
          } catch (e) {
            console.error('[SR] startErr', e);
          }
        }
        function stopRecognition() {
          console.log('[SR] stopRecognition');
          recognition.stop();
        }
        function updateRecordingTime() {
          if (!isRecording) return;
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const s = String(elapsed % 60).padStart(2, '0');
          recordingTime.textContent = `${m}:${s}`;
          setTimeout(updateRecordingTime, 1000);
        }
        function initImport() {
          console.log('[initImport]');
          impBtn.addEventListener('click', () => {
            const tabId = localStorage.getItem('activeTab');
            const choice = prompt('Zadej 1 pro v√Ωbƒõr souboru, nebo 2 pro vlo≈æen√≠ QR k√≥du jako text (base64 JSON):', '1');
            if (choice === '2') {
              const input = prompt('Vlo≈æ base64 QR obsah:');
              if (input) {
                try {
                  const json = decodeURIComponent(escape(atob(input)));
                  const data = JSON.parse(json);
                  tabsData[tabId] = data;
                  persist();
                  const bd = document.querySelector(`#${tabId} .tab-content-body`);
                  bd.innerHTML = '';
                  data.forEach(t => addButton(t, tabId));
                  console.log('[import] QR OK');
                } catch (err) {
                  console.error('[import] QR ERR', err);
                  alert('Neplatn√Ω QR obsah');
                }
              }
            } else {
              fileInput.onchange = async e => {
                const f = e.target.files[0];
                if (!f) return;
                try {
                  const txt = await f.text();
                  tabsData[tabId] = JSON.parse(txt);
                  persist();
                  const bd = document.querySelector(`#${tabId} .tab-content-body`);
                  bd.innerHTML = '';
                  tabsData[tabId].forEach(t => addButton(t, tabId));
                  console.log('[import] soubor OK');
                } catch (err) {
                  console.error('[import] soubor ERR', err);
                  alert('Neplatn√Ω JSON');
                }
                e.target.value = '';
              };
              fileInput.click();
            }
          });
        }
        function initExport() {
          console.log('[initExport]');
          expBtn.addEventListener('click', () => {
            const tabId = localStorage.getItem('activeTab');
            const arr = Array.from(document.querySelectorAll(`#${tabId} .text-button`)).map(b => b.textContent);
            const json = JSON.stringify(arr, null, 2);
            // Download jako soubor
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tabId}.json`;
            document.body.append(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            console.log('[export] file downloaded');
            // QR k√≥d
            const encoded = btoa(unescape(encodeURIComponent(json)));
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
              text: encoded,
              width: 260,
              height: 260,
              colorDark: '#000',
              colorLight: '#fff',
              correctLevel: QRCode.CorrectLevel.H
            });
            const modal = new bootstrap.Modal(document.getElementById('qrModal'));
            modal.show();
          });
        }
        function initEraseData() {
          console.log('[initEraseData]');
          eraseBtn.addEventListener('click', () => {
            if (!confirm('Vymazat v≈°echna data?')) return;
            localStorage.clear();
            customTabs.length = 0;
            for (const k in tabsData) delete tabsData[k];
            persist();
            document.querySelectorAll('.tab-button').forEach(b => b.dataset.tab !== TAB_PREDEFINED && b.remove());
            document.querySelectorAll('.tab-content').forEach(c => c.id !== TAB_PREDEFINED && c.remove());
            activateTab(TAB_PREDEFINED);
            location.reload();
          });
        }
        function initShare() {
          console.log('[initShare]');
          const qrScript = document.createElement('script');
          qrScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
          document.head.append(qrScript);
          shareBtn.addEventListener('click', () => {
            console.log('[share]');
            const modal = new bootstrap.Modal(document.getElementById('qrModal'));
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
              text: window.location.href,
              width: 260,
              height: 260,
              colorDark: '#000',
              colorLight: '#fff',
              correctLevel: QRCode.CorrectLevel.H
            });
            modal.show();
          });
        }
        function initHelp() {
          console.log('[initHelp]');
          helpBtn.addEventListener('click', () => {
            document.getElementById('helpToastBody').innerHTML =
              `<b>A‚ÄìZ</b> p≈ôeƒçten√≠ textu tlaƒç√≠tek<br>
            <b>1‚Äì9</b> zmƒõna z√°lo≈æky tlaƒç√≠tek<br>
            <b>;</b> hlavn√≠ menu<br>
            <b>Ctrl</b> ovl√°d√°n√≠ p≈ôepisu ≈ôeƒçi`;
            toast.show();
          });
        }

        function initPWA() {
          console.log('[PWA] Disabled: service worker registration skipped');
        }

        function changeTab(index) {
          // Najdi v≈°echny taby
          const tabs = Array.from(document.querySelectorAll('.tab-button'));
          if (index >= 0 && index < tabs.length) {
            tabs[index].click();
          }
        }
        function enableSwipeNavigation() {
          let startX = 0,
            endX = 0;
          const tabs = Array.from(document.querySelectorAll('.tab-button'));
          document.addEventListener('touchstart', e => startX = e.touches[0].clientX);
          document.addEventListener('touchend', e => {
            endX = e.changedTouches[0].clientX;
            const activeIdx = tabs.findIndex(t => t.classList.contains('active'));
            if (startX - endX > 50 && activeIdx < tabs.length - 1) {
              animateTabTransition('left');
              activateTab(tabs[activeIdx + 1].dataset.tab);
            } else if (endX - startX > 50 && activeIdx > 0) {
              animateTabTransition('right');
              activateTab(tabs[activeIdx - 1].dataset.tab);
            }
          });
        }
        function animateTabTransition(dir) {
          const ac = document.querySelector('.tab-content.active');
          if (!ac) return;
          const cl = dir === 'left' ? 'slide-out-left' : 'slide-out-right';
          ac.classList.add(cl);
          setTimeout(() => ac.classList.remove(cl), 300);
        }

        document.addEventListener('DOMContentLoaded', () => {
          loadSettings();
          // avatar toggle po naƒçten√≠ nastaven√≠
          window.AvatarDock?.setEnabled?.(settings.avatarEnabled);
          initTabs();
          initVoice();
          initImport();
          initExport();
          initEraseData();
          initShare();
          initHelp();
          initPWA();
          enableSwipeNavigation();
          const items = document.querySelectorAll('.dropdown-menu .dropdown-item');
          items.forEach((item, i) => {
            item.dataset.index = i + 1;
            const label = document.createElement('span');
            label.className = 'hotkey-label ms-auto text-muted small';
            label.textContent = `${i + 1}`;
            label.style.marginLeft = 'auto';
            label.style.fontSize = '0.8em';
            label.style.opacity = '0.6';
            label.style.pointerEvents = 'none';
            item.appendChild(label);
          });
          document.addEventListener('keydown', e => {
            // Kdy≈æ NEN√ç otev≈ôen√© menu, a nejsme v inputu nebo textarea
            if (
              !isDropdownOpen() &&
              !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)
            ) {
              if (
                e.ctrlKey &&
                !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)
              ) {
                if (!isRecording && localStorage.getItem('activeTab') !== TAB_PREDEFINED) {
                  e.preventDefault();
                  startRecognition();
                } else if (isRecording) {
                  e.preventDefault();
                  stopRecognition();
                }
              }
              if (/^Digit[1-9]$/.test(e.code)) {
                const idx = parseInt(e.code.replace('Digit', ''), 10) - 1;
                changeTab(idx);
                e.preventDefault();
              }
            }
            if (
              e.key === ';' &&
              !e.ctrlKey &&
              !e.altKey &&
              !e.metaKey &&
              !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)
            ) {
              e.preventDefault();
              const dropdownBtn = document.getElementById('menuDropdown');
              const dropdown = bootstrap.Dropdown.getOrCreateInstance(dropdownBtn);
              // Toggle dropdown (open/close)
              const isOpen = dropdownBtn.getAttribute('aria-expanded') === 'true';
              if (isOpen) {
                dropdown.hide();
              } else {
                dropdown.show();
                // Fokusuj prvn√≠ prvek v menu
                setTimeout(() => {
                  document.querySelector('.dropdown-menu .dropdown-item:not([disabled])')?.focus();
                }, 100);
              }
            }
            if (!isDropdownOpen()) return;
            // Aktivace polo≈æky ƒç√≠slem 1‚Äì9
            if (/^Digit[1-9]$/.test(e.code)) {
              const idx = parseInt(e.code.replace('Digit', ''), 10) - 1;
              const items = Array.from(document.querySelectorAll('.dropdown-menu .dropdown-item:not([disabled])'));
              if (items[idx]) {
                items[idx].click();
                e.preventDefault();
                return;
              }
            }
            const items = Array.from(document.querySelectorAll('.dropdown-menu .dropdown-item:not([disabled])'));
            const index = items.indexOf(document.activeElement);
            if (e.key === 'Escape') {
              bootstrap.Dropdown.getInstance(document.getElementById('menuDropdown'))?.hide();
            }
            if (e.ctrlKey && !isRecording && localStorage.getItem('activeTab') !== TAB_PREDEFINED) {
              // Ctrl = start/stop recording
              e.preventDefault();
              startRecognition();
            } else if (e.ctrlKey && isRecording) {
              e.preventDefault();
              stopRecognition();
            }
          });
          function isDropdownOpen() {
            const dropdown = document.querySelector('.dropdown-menu.show');
            return !!dropdown;
          }
          function loadVoicesThenInit() {
            const tryInit = () => {
              const voices = speechSynthesis.getVoices();
              if (voices.length) {
                initSettings(); // tvoje p≈Øvodn√≠ funkce ‚Äì beze zmƒõn
              } else {
                speechSynthesis.onvoiceschanged = () => {
                  initSettings(); // zavol√° se a≈æ po naƒçten√≠ hlas≈Ø
                };
              }
            };
            // Nƒõkter√© prohl√≠≈æeƒçe naƒçtou hlasy a≈æ po men≈°√≠ prodlevƒõ
            setTimeout(tryInit, 100); // m√≠rn√© zpo≈ædƒõn√≠ pro jistotu
          }
          // Start
          loadVoicesThenInit();
        });
      })(); 
 // bezpeƒçn√° TTS funkce
function speakSafe(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'cs-CZ';
  utter.rate = 1;
  window.speechSynthesis.speak(utter);
}

let overlay = null;
let outageStart, outageTimer;

navigator.serviceWorker.addEventListener('message', event => {
  if (event.data?.type !== 'connection-status') return;
  if (event.data.status === 'disconnected') showOverlay();
  else hideOverlay();
});

function showOverlay() {
  if (overlay) return;
  outageStart = new Date();
  overlay = document.createElement('div');
  overlay.id = 'connection-overlay';
  overlay.style.cssText = `
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.8);color:white;
    font-family:sans-serif;z-index:9999;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    text-align:center;padding:2rem
  `;
  overlay.innerHTML = `
   <h1>üì° Ztr√°ta p≈ôipojen√≠</h1>
  <p>Od: <span id="out-start">--:--:--</span></p>
  <p>Trv√°: <span id="out-duration">0 s</span></p>
  <div class="signal-bars">
    <div class="bar"></div><div class="bar"></div>
    <div class="bar"></div><div class="bar"></div>
  </div>
  <div class="loader" style="display:none"></div>
  `;
  document.body.appendChild(overlay);
  speakSafe('V√Ωpadek sign√°lu.');
  document.getElementById('out-start').textContent = outageStart.toLocaleTimeString('cs-CZ');
  outageTimer = setInterval(() => {
    const sec = Math.floor((new Date() - outageStart) / 1000);
    document.getElementById('out-duration').textContent = `${sec} s`;
  }, 1000);
}

function hideOverlay() {
  if (!overlay) return;
  clearInterval(outageTimer);
  const sec = Math.floor((new Date() - outageStart) / 1000);
  speakSafe(`Sign√°l obnoven. V√Ωpadek ${sec} sekund.`);
  overlay.remove();
  overlay = null;
}

        /* ---------- AVATAR DOCK (Adam) --------------------------------------
           Pozn.: avatar je a≈æ dole v DOM, tak≈æe init mus√≠ bƒõ≈æet po DOMContentLoaded.
           Implementace bez GSAP: rAF ticker + jednoduch√© transformy.
        --------------------------------------------------------------------- */
        (function initAvatarDockWhenReady(){
          function init(){
            const dock = document.getElementById('avatarDock');
            const svg = document.getElementById('adam-svg');
            const bubbleEl = document.getElementById('avatarBubble');

            // Minimal HTML escaping for bubble rendering.
            const escHtml = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;'
            }[c]));
            if (!dock || !svg) return;

            const q = (sel) => svg.querySelector(sel);
            const els = {
              head: q('#head-group'),
              face: q('#face-features'),
              glasses: q('#glasses-group'),
              obrouckaGlint: q('#obroucka-glint'),
              frameGlint: q('#frameGlint'),
              mouthGroup: q('#mouth-group'),
              hands: q('#hands-group'),
              ears: q('#ears'),
              irises: [q('#iris-group-l'), q('#iris-group-r')].filter(Boolean),
              glares: [q('#glare-l'), q('#glare-r')].filter(Boolean),
              mouthClosed: q('#mouth-closed'),
              mouthOpen: q('#mouth-open'),
              lidsUp: [q('#lid-up-l'), q('#lid-up-r')].filter(Boolean),
              lidsLow: [q('#lid-low-l'), q('#lid-low-r')].filter(Boolean),
              eyebrows: q('#eyebrows')
            };

            if (!els.mouthOpen || !els.mouthClosed) return;

            // Ulo≈æ√≠me p≈Øvodn√≠ transformy, abychom je nep≈ôepsali "natvrdo".
            const baseTf = new Map();
            const remember = (el) => {
              if (!el || baseTf.has(el)) return;
              baseTf.set(el, el.getAttribute('transform') || '');
              // lep≈°√≠ chov√°n√≠ style.transform u SVG
              try { el.style.transformBox = 'fill-box'; } catch {}
            };
            [els.head, els.face, els.glasses, els.mouthGroup, els.hands, els.ears, els.eyebrows,
             ...els.irises, ...els.glares, ...els.lidsUp, ...els.lidsLow].forEach(remember);

            const setTf = (el, extra) => {
              if (!el) return;
              const b = baseTf.get(el) || '';
              // base + extra (extra a≈æ nakonec)
              el.setAttribute('transform', (b ? (b + ' ') : '') + extra);
            };

            // Stav
            let enabled = false;
            let isTalking = false;
            let isIdle = false;
            let idleT = null;
            const mouse = { x: 0, y: 0 };
            const cur = { x: 0, y: 0 };
            let rafId = null;


// Mimika (plynul√© p≈ôechody) ‚Äì ovliv≈àuje oboƒç√≠ + pozici/≈°k√°lu pusy p≈ôi zav≈ôen√Ωch √∫stech
const exprCur = { browY: 0, browRot: 0, mouthY: 0, mouthS: 0 };
const exprTgt = { browY: 0, browRot: 0, mouthY: 0, mouthS: 0 };
const lerp = (a,b,k) => a + (b-a)*k;

function setExprTarget(p){
  exprTgt.browY   = Number(p?.browY   || 0);
  exprTgt.browRot = Number(p?.browRot || 0);
  exprTgt.mouthY  = Number(p?.mouthY  || 0);
  exprTgt.mouthS  = Number(p?.mouthS  || 0);
}

function pickExpression(text){
  // deterministick√Ω v√Ωbƒõr dle textu (a≈• je to konzistentn√≠ na stejn√© tlaƒç√≠tko)
  const s = String(text || '');
  let h = 2166136261;
  for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  const r = (h >>> 0) % 5;

  // 0 neutral, 1 happy, 2 angry, 3 surprised, 4 skeptical
  if (r === 1) return { browY: -0.2, browRot: 0, mouthY: -1.5, mouthS:  0.18 };
  if (r === 2) return { browY:  2.4, browRot:  0, mouthY:  1.6, mouthS: -0.12 };
  if (r === 3) return { browY: -0.1, browRot:  0.0, mouthY:  0.4, mouthS:  0.02 };
  if (r === 4) return { browY:  0.8, browRot: 0, mouthY:  0.8, mouthS: -0.04 };
  return { browY: 0, browRot: 0, mouthY: 0, mouthS: 0 };
}

            // V√Ωchoz√≠ pusa
            els.mouthOpen.style.opacity = '0';
            els.mouthClosed.style.opacity = '1';
            // P≈ôiprav transformy pro pusu (variabiln√≠ otev≈ôen√≠)
            try {
              els.mouthOpen.style.transformBox = 'fill-box';
              els.mouthOpen.style.transformOrigin = 'center';
              els.mouthClosed.style.transformBox = 'fill-box';
              els.mouthClosed.style.transformOrigin = 'center';
            } catch {}

            // Bublina (text co se ƒçte)
            function bubbleShow(text){
              if (!bubbleEl) return;
              bubbleEl.hidden = false;
              // Show full text by default.
              bubbleEl.textContent = String(text || '');
            }
            function bubbleHide(){
              if (!bubbleEl) return;
              bubbleEl.hidden = true;
              bubbleEl.textContent = '';
            }
            function bubbleProgress(fullText, charIndex){
              if (!bubbleEl) return;
              bubbleEl.hidden = false;
              // Keep the FULL text visible; optionally emphasize the already spoken part.
              // Some voices fire boundary events immediately with small indices.
              const txt = String(fullText || '');
              const i = Math.max(0, Math.min(txt.length, Number(charIndex || 0)));
              const spoken = txt.slice(0, i);
              const rest = txt.slice(i);
              // Render as HTML so we can visually differentiate spoken vs. remaining.
              bubbleEl.innerHTML = `<span class="spoken">${escHtml(spoken)}</span><span class="rest">${escHtml(rest)}</span>`;
            }

            // Lipsync (varianta B ‚Äì text-driven aproximace podle p√≠smen)
            let lipTimer = null;
            function visemeForChar(ch){
              ch = (ch || '').toLowerCase();
              if ('mbp'.includes(ch)) return 0.05;        // zav≈ô√≠t
              if ('ou≈Ø√∫'.includes(ch)) return 0.35;       // kulat√©
              if ('aei√°√©ƒõ√≠'.includes(ch)) return 0.70;    // otev≈ôen√©
              if ('y√Ω'.includes(ch)) return 0.45;
              if ('fvvw'.includes(ch)) return 0.25;
              if (ch === ' ') return 0.08;
              return 0.18;
            }
            function setMouthOpen(amount){
              // amount 0..1 (otev≈ôen√≠)
              const a = Math.max(0, Math.min(1, Number(amount) || 0));
              // uk√°≈æeme otev≈ôenou pusu a ≈°k√°lujeme ji v ose Y
              els.mouthOpen.style.opacity = '1';
              els.mouthClosed.style.opacity = '0';
              const sy = (0.35 + a * 0.95).toFixed(3); // 0.35..1.30
              els.mouthOpen.style.transform = `scale(1, ${sy})`;
            }
            function mouthClosed(){
              els.mouthOpen.style.opacity = '0';
              els.mouthClosed.style.opacity = '1';
              els.mouthOpen.style.transform = '';
            }
            function lipsyncStop(){
              if (lipTimer) { clearInterval(lipTimer); lipTimer = null; }
              mouthClosed();
            }
            function lipsyncText(text, rate=1){
              lipsyncStop();
              const s = String(text || '');
              if (!s) return;
              // Odhad rychlosti ‚Äì cca 15 znak≈Ø/s p≈ôi rate=1
              const cps = Math.max(6, 15 * (Number(rate) || 1));
              const stepMs = Math.max(35, Math.round(1000 / cps));
              let i = 0;
              lipTimer = setInterval(() => {
                if (!enabled || !isTalking){ lipsyncStop(); return; }
                if (i >= s.length){ lipsyncStop(); return; }
                const open = visemeForChar(s[i++]);
                setMouthOpen(open);
              }, stepMs);
            }

            function onMouseMove(e){
              if (!enabled || isTalking) return;
              isIdle = false;
              if (idleT) clearTimeout(idleT);
              idleT = setTimeout(() => { isIdle = true; }, 2500);

              const b = svg.getBoundingClientRect();
              const cx = b.left + b.width/2;
              const cy = b.top + b.height/2;
              // normalizace podobnƒõ jako v p≈Øvodn√≠m adam.html
              const nx = (e.clientX - cx) / (window.innerWidth * 0.4);
              const ny = (e.clientY - cy) / (window.innerHeight * 0.4);
              mouse.x = Math.max(-1, Math.min(1, nx));
              mouse.y = Math.max(-1, Math.min(1, ny));
            }

            function tick(ts){
              if (!enabled){ rafId = null; return; }

              const t = ts / 1000;

              // idle bloudƒõn√≠
              if (isIdle && !isTalking){
                mouse.x = Math.sin(t * 0.6) * 0.28;
                mouse.y = Math.cos(t * 0.45) * 0.18;
              }

              // lerp
              cur.x += (mouse.x - cur.x) * 0.10;
              cur.y += (mouse.y - cur.y) * 0.10;
              const cx = cur.x;
              const cy = cur.y;


// Mimika lerp
exprCur.browY   = lerp(exprCur.browY,   exprTgt.browY,   0.08);
exprCur.browRot = lerp(exprCur.browRot, exprTgt.browRot, 0.08);
exprCur.mouthY  = lerp(exprCur.mouthY,  exprTgt.mouthY,  0.10);
exprCur.mouthS  = lerp(exprCur.mouthS,  exprTgt.mouthS,  0.10);

              // Parallax (ladƒõno m√≠rnƒõ m√©nƒõ agresivnƒõ)
              if (els.head)   setTf(els.head,   `translate(${(cx*10).toFixed(2)} ${(cy*6).toFixed(2)}) rotate(${(cx*6).toFixed(2)} 300 300)`);
              if (els.face)   setTf(els.face,   `translate(${(cx*8).toFixed(2)} ${(cy*8).toFixed(2)})`);
              if (els.mouthGroup) setTf(els.mouthGroup, `translate(0 ${exprCur.mouthY.toFixed(2)}) scale(${(1+exprCur.mouthS).toFixed(3)} 1)`);
              if (els.glasses)setTf(els.glasses,`translate(${(cx*12).toFixed(2)} ${(cy*10).toFixed(2)})`);


// Odlesk obrouƒçek (frame glint) ‚Äì posun/rotace dle kurzoru, p≈ôi mluven√≠ silnƒõj≈°√≠
if (els.obrouckaGlint){
  const base = isTalking ? 0.75 : 0.35;
  // jemn√© bliknut√≠
  const pulse = isTalking ? (0.15 + 0.15*Math.sin(t*8)) : (0.05 + 0.08*Math.sin(t*2.2));
  els.obrouckaGlint.setAttribute('opacity', String(Math.max(0, Math.min(0.95, base + pulse))));
}
if (els.frameGlint){
  const tx = (cx*35);
  const ty = (cy*18);
  const rot = (cx*18);
  els.frameGlint.setAttribute('gradientTransform', `translate(${tx.toFixed(2)} ${ty.toFixed(2)}) rotate(${rot.toFixed(2)} 300 245)`);
}
              if (els.ears)   setTf(els.ears,   `translate(${(-cx*5).toFixed(2)} 0)`);
              if (els.eyebrows) setTf(els.eyebrows, `translate(0 ${((cy*-2) + exprCur.browY).toFixed(2)}) rotate(${(exprCur.browRot).toFixed(2)} 300 210)`);

              // Oƒçi
              els.irises.forEach(el => setTf(el, `translate(${(cx*10).toFixed(2)} ${(cy*8).toFixed(2)})`));
              els.glares.forEach(el => setTf(el, `translate(${(-cx*4).toFixed(2)} ${(-cy*4).toFixed(2)})`));

              // Jemn√© "d√Ωch√°n√≠" rukou (pokud nemluv√≠)
              if (els.hands){
                const breathe = (!isTalking) ? (Math.sin(t * 2.2) * 2.5) : 0;
                setTf(els.hands, `translate(0 ${(breathe).toFixed(2)})`);
              }

              rafId = requestAnimationFrame(tick);
            }

            // Mrk√°n√≠
            function blink(){
              if (!enabled || isTalking) { setTimeout(blink, 1200); return; }
              // zav≈ôi
              els.lidsUp.forEach(el => setTf(el, `translate(0 6)`));
              els.lidsLow.forEach(el => setTf(el, `translate(0 -6)`));
              setTimeout(() => {
                // otev≈ôi
                els.lidsUp.forEach(el => setTf(el, `translate(0 0)`));
                els.lidsLow.forEach(el => setTf(el, `translate(0 0)`));
              }, 110);
              setTimeout(blink, 1800 + Math.random()*2500);
            }
            setTimeout(blink, 1200);

            // ve≈ôejn√© API
            window.AvatarDock = {
              react(text){
                // nastav v√Ωraz (p≈ôi ka≈æd√©m ƒçten√≠ nƒõco jin√©ho)
                setExprTarget(pickExpression(text));
              },
              setEnabled(on){
                enabled = !!on;
                dock.classList.toggle('is-hidden', !enabled);
                dock.setAttribute('aria-hidden', enabled ? 'false' : 'true');
                if (!enabled){
                  this.talk(false);
                  window.removeEventListener('mousemove', onMouseMove);
                  if (rafId) cancelAnimationFrame(rafId);
                  rafId = null;
                  return;
                }
                window.addEventListener('mousemove', onMouseMove, { passive: true });
                // start ticker
                if (!rafId) rafId = requestAnimationFrame(tick);
              },
              talk(on){
                isTalking = !!on;
                if (isTalking){
                  // p≈ôi startu ≈ôeƒçi zvol v√Ωraz (pokud nebyl nastaven p≈ôes react)
                  // nech√°me target tak jak je, nebo ho nastav√≠me na lehk√Ω "mluv√≠c√≠" preset
                  if (exprTgt.browY===0 && exprTgt.browRot===0 && exprTgt.mouthY===0 && exprTgt.mouthS===0){
                    setExprTarget({ browY:-1.2, browRot:-0.8, mouthY:-0.6, mouthS:0.06 });
                  }
                } else {
                  // n√°vrat do neutr√°lu
                  setExprTarget({ browY:0, browRot:0, mouthY:0, mouthS:0 });
                }
                dock.classList.toggle('is-talking', isTalking);
                if (!isTalking){
                  lipsyncStop();
                } else {
                  // kdy≈æ je≈°tƒõ nebƒõ≈æ√≠ lipsync, alespo≈à trochu otev≈ôeme pusu
                  setMouthOpen(0.22);
                }
              },
              bubbleShow,
              bubbleHide,
              bubbleProgress,
              lipsyncText,
              lipsyncStop
            };

            // okam≈æit√° synchronizace se stavem v nastaven√≠ (d≈ô√≠v ne≈æ u≈æivatel cokoliv klikne)
            // p≈Øvodn√≠ probl√©m: AvatarDock vznik√° a≈æ po DOMContentLoaded, ale nastaven√≠ se naƒç√≠talo d≈ô√≠v.
            try {
              const saved = JSON.parse(localStorage.getItem('avatarEnabled') || 'false');
              const chk = document.getElementById('avatarEnabled');
              if (chk) chk.checked = !!saved;
              if (typeof settings === 'object' && settings) settings.avatarEnabled = !!saved;
              window.AvatarDock.setEnabled(!!saved);
            } catch {}
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init, { once:true });
          } else {
            init();
          }
        })();

</script>



  <!-- Avatar (Adam) ‚Äì zobraz√≠ se podle nastaven√≠ -->
  <div id="avatarDock" class="avatar-dock is-hidden" aria-hidden="true">
    <div class="avatar-bubble" id="avatarBubble" hidden></div>
    <svg id="adam-svg" viewBox="0 0 600.4 700" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <!-- P≈Øvodn√≠ gradient vlas≈Ø -->
            <linearGradient id="vlasy_grad" gradientUnits="userSpaceOnUse" x1="161.852" y1="568.3929" x2="438.4455" y2="568.3929" gradientTransform="matrix(1 0 0 -1 0 710)">
                <stop offset="0" style="stop-color:#693E12"></stop>
                <stop offset="1" style="stop-color:#4D2008"></stop>
            </linearGradient>
            <!-- Gradient br√Ωl√≠ -->
            <linearGradient id="cool" gradientUnits="userSpaceOnUse" x1="250.9569" y1="277.1053" x2="250.0863" y2="215.9759">
                <stop offset="0" style="stop-color:#4A017D;stop-opacity:0.4"></stop>
                <stop offset="1" style="stop-color:#FE330A;stop-opacity:0.4"></stop>
            </linearGradient>
            
            
<!-- Odlesk na obrouƒçk√°ch (dynamick√Ω) -->
<linearGradient id="frameGlint" gradientUnits="userSpaceOnUse" x1="160" y1="200" x2="420" y2="290">
    <stop offset="0" style="stop-color:#FFFFFF;stop-opacity:0"></stop>
    <stop offset="0.40" style="stop-color:#FFFFFF;stop-opacity:0"></stop>
    <stop offset="0.52" style="stop-color:#FFFFFF;stop-opacity:0.62"></stop>
    <stop offset="0.62" style="stop-color:#FFFFFF;stop-opacity:0"></stop>
    <stop offset="1" style="stop-color:#FFFFFF;stop-opacity:0"></stop>
</linearGradient>
            <!-- DEFINICE O≈òEZOV√ùCH MASEK (Aby oƒçi nevyj√≠≈ædƒõly) -->
            <clipPath id="clip-eye-left">
                <path d="M220.7,240.5c0,0,5.5,7.6,6.9,7.6c1.4,0.3,10.7,3.8,13.2,3.8c2.4,0,18,0,20.8-0.7 c2.4-0.7,10.4-1.4,11.4-2.1c1-0.7,5.9-2.8,5.9-4.9c0-2.4,0.3-4.2,0-5.5s-3.1-4.9-4.9-5.5c-1.7-0.7-12.1-5.5-14.9-5.5 s-18.7-1-20.8-0.3c-2.1,0.7-5.5,0.7-7.6,1.7c-1.7,1-5.5,3.8-6.6,4.5c-1,0.7-2.4,2.1-2.8,2.8c-0.3,0.7-1,2.1-1,2.4 C220.7,239.5,220.7,240.5,220.7,240.5z"></path>
            </clipPath>
            <clipPath id="clip-eye-right">
                <path d="M379.7,240.5c0,0-5.5,7.6-6.9,7.6c-1.4,0.3-10.7,3.8-13.2,3.8c-2.4,0-18,0-20.8-0.7 c-2.4-0.7-10.4-1.4-11.4-2.1c-1-0.7-5.9-2.8-5.9-4.9c0-2.4-0.3-4.2,0-5.5c0.3-1.4,3.1-4.9,4.9-5.5c1.7-0.7,12.1-5.5,14.9-5.5 s18.7-1,20.8-0.3c2.1,0.7,5.5,0.7,7.6,1.7c1.7,1,5.5,3.8,6.6,4.5s2.4,2.1,2.8,2.8c0.3,0.7,1,2.1,1,2.4S379.7,240.5,379.7,240.5z"></path>
            </clipPath>
        </defs>

        <g id="adam-wrapper" transform="matrix(1, 0, 0, 1, 0, 65.5)">
            
            <!-- TƒöLO (Stoj√≠, d√Ωch√°) -->
            <g id="body-group">
                <path id="krk" style="fill:#C1A080;" d="M373.8,484.7c-9.7-28.5-4.5-167.3-4.5-167.3l-69.3-3l-69.3,3c0,0,5.2,138.8-4.5,167.3 C216.5,513.2,300,535,300,535S383.5,513.2,373.8,484.7z"></path>
                <path id="tricko" fill="#193d56" d="M600.4,634.5c0,0-70.3-179.8-90.4-194.4C465.3,407.9,368,402,368,402c-3.5,95.6-67.6,90.4-67.6,90.4H300 c0,0-63.8,4.9-67.6-90.4c0,0-97.4,5.9-142.1,38.1C70.3,454.7,0,634.5,0,634.5"></path>
            </g>

            <!-- HLAVA (Rotuje cel√°) -->
            <g id="head-group" transform-origin="300 300" data-svg-origin="462.35040283203125 304.8680114746094" transform="matrix(1,-0.00041,0.00041,1,-0.1714,-0.11034)" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                
                <!-- U≈†I (Jsou vzadu) -->
                <g id="ears" data-svg-origin="176.68995666503906 219" transform="matrix(1,0,0,1,0.0232,0)" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                    <path id="ucho-l" style="fill:#E0BB91;" d="M197.1,242.6c0,0-7.6-23.6-12.8-23.6s-8.7,0-7.3,4.5c1.4,4.5,5.2,11.4,4.9,14.6 c-0.3,3.1-1.4,30.1-1,38.1c0.3,7.6-2.1,21.1,2.1,25.3c4.2,4.2,0.3,5.5,6.2,8.7s12.5-44.7,12.5-44.7L197.1,242.6z"></path>
                    <path id="ucho-r" style="fill:#E0BB91;" d="M402.9,242.6c0,0,7.6-23.6,12.8-23.6c5.2,0,8.7,0,7.3,4.5c-1.4,4.5-5.2,11.4-4.9,14.6 c0.3,3.1,1.4,30.1,1,38.1c-0.3,7.6,2.1,21.1-2.1,25.3c-4.2,4.2-0.3,5.5-6.2,8.7c-5.9,3.1-12.5-44.7-12.5-44.7L402.9,242.6z"></path>
                </g>

                <!-- TVAR OBLIƒåEJE -->
                <path id="face-shape" style="fill:#F0CC99;" d="M424.9,134.5c0,0-33.4-55.1-42-62c-8.7-6.9-28.8-29.8-45.7-33.6c-17-3.8-37.1-3.8-37.1-3.8 s-20.1,0-37.1,3.8c-17,3.8-37.1,26.7-45.7,33.6c-8.7,6.9-38.9,50.9-41.3,62c-2.4,11.1,19.8,182.2,19.8,182.2s2.8,28.8,8.3,56.1 c1,5.2,13.9,33.6,28.4,59.9c14.2,25.3,34.3,48.5,67.2,42.3c32.9,6.2,53-16.6,67.2-42.3c14.9-26.3,27.4-55.1,28.4-59.9 c5.5-27.4,8.3-56.1,8.3-56.1L424.9,134.5z"></path>

                <!-- VLASY (P≈Øvodn√≠ tvar) -->
                <path id="hair" style="fill:url(#vlasy_grad);" d="M427.9,85.7c-19.1-23.6-20.1-33.3-53.7-55.4C317.4-6.8,311.8,7.7,300.4,7.7 c-11.4,0-17-14.6-73.8,22.5c-34,22.2-34.6,31.9-53.7,55.4c-19.7,24.3-5.5,77.3-6.9,99.8c-1.4,22.2,27.7,92.9,27.7,92.9 s-0.7-66.2,0-77.6c0.7-11.4-2.4-26.3,1-35c4.5-11.1,27.7-43.3,36.7-53c20.1-20.8,54.4-16.3,69.3-0.3c14.9-15.9,49.2-20.4,69.3,0.3 c9.4,9.4,32.2,41.6,36.7,53c3.5,8.7,0.3,23.6,1,35c0.7,11.4,0,77.6,0,77.6s29.1-70.7,27.7-92.9C433.4,162.9,447.6,109.6,427.9,85.7 z"></path>

                <!-- OBLIƒåEJOV√â RYSY (Parallax) -->
                <g id="face-features" data-svg-origin="204.40000915527344 207.3363800048828" transform="matrix(1,0,0,1,-0.0371,-0.4798)" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                    
                    <!-- OBOƒå√ç -->
                    <g id="eyebrows">
                        <path id="eb-l" style="fill:#693E10;" d="M246,219.1c-10.7,1.4-18.7,7.3-27.7,12.5c-9,5.2-13.9,7.3-13.9,7.3 s1.4-1.7,18.7-19.7c10-10.4,19.4-9.7,27-11.4c8.7-2.1,23.6,3.5,26.7,5.5"></path>
                        <path id="eb-r" style="fill:#693E10;" d="M354.4,219.1c10.7,1.4,18.7,7.3,27.7,12.5c9,5.2,13.9,7.3,13.9,7.3 s-1.4-1.7-18.7-19.7c-10-10.4-19.4-9.7-27-11.4c-8.7-2.1-23.6,3.5-26.7,5.5C320.1,214.9,343.7,217.7,354.4,219.1z"></path>
                    </g>

                    <!-- √öSTA (P≈ôep√≠nac√≠ skupiny) -->
                    <g id="mouth-group" class="interactive">
                        <!-- ZAV≈òEN√Å -->
                        <g id="mouth-closed" style="opacity: 1;">
                            <path class="usta" style="fill: rgb(153, 18, 9);" d="M336.6,382.8c-4.2,0-11.1-1-20.1-1s-15.9,2.1-15.9,2.1s-6.9-2.1-15.9-2.1s-15.6,1-20.1,1 c-4.2,0-14.6,0.7-14.6,0.7s2.1,1,8,6.9s10.4,8.3,17.3,11.8s11.4,5.5,17.3,5.5s7.6,0,7.6,0s1.7,0,7.6,0s10.4-2.1,17.3-5.5 c6.9-3.5,11.4-6.2,17.3-11.8c5.9-5.9,8-6.9,8-6.9S340.7,382.8,336.6,382.8z M320.1,384.4c-9.4,2.8-19.6-0.3-19.6-0.3s-11,3-20.4,0.3s-22.9-0.4-22.9-0.4l22.9,1.4c8.7,1,20.1,1.7,20.1,1.7s11.8-0.7,20.1-1.7l22.9-1.4C343.9,384,329.5,381.7,320.1,384.4z"></path>
                        </g>
                        <!-- OTEV≈òEN√Å (P≈Øvodn√≠ cesta) -->
                        <g id="mouth-open" style="opacity: 0; translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" data-svg-origin="301.2000427246094 390" transform="matrix(1,0,0,1,0,0)">
                            <path id="dutina" fill="#510707" d="M301.6,372.1h-0.5c0,0-32,3-31,10s31,26,31,26h0.5c0,0,30-19,31-26 S301.6,372.1,301.6,372.1z"></path>
                            <!-- ZUBY (P≈Øvodn√≠) -->
                            <g id="teeth">
                                <path fill="#FFFFFF" stroke="#020202" stroke-width="0.2" d="M295.2,374.5c0,0-1,5.8,0,6.1c1.2,0.4,4.2,0.6,4.9-0.1c0.5-0.4,0.3-6,0.3-6H295.2z"></path>
                                <path fill="#FFFFFF" stroke="#020202" stroke-width="0.2" d="M289.8,374.5c0,0-0.9,5.8,0,6.1c1.1,0.4,3.8,0.6,4.5-0.1c0.4-0.4,0.3-6,0.3-6H289.8z"></path>
                                <path fill="#FFFFFF" stroke="#020202" stroke-width="0.2" d="M306,374.5c0,0,1,5.8,0,6.1c-1.2,0.4-4.2,0.6-4.9-0.1c-0.5-0.4-0.3-6-0.3-6H306z"></path>
                                <path fill="#FFFFFF" stroke="#020202" stroke-width="0.2" d="M311.4,374.5c0,0,0.9,5.8,0,6.1c-1.1,0.4-3.8,0.6-4.5-0.1c-0.4-0.4-0.3-6-0.3-6H311.4z"></path>
                            </g>
                            <path id="lips-open" fill="#991209" d="M324,365.7c-1.9-2.8-6.9-7.2-12.5-7.2s-9.9,3-9.9,3s-4.3-3-9.9-3s-10.1,3.8-12.5,7.2 c-1.8,2.6-11.1,16.8-11.1,16.8s3.3,7.2,7,15.6c3.7,8.5,6.5,10.5,10.7,15.5c4.3,5,7.1,7.9,10.7,7.9s4.7,0,4.7,0s1.1,0,4.7,0 s6.5-3,10.7-7.9c4.3-5,7.1-7.5,10.7-15.5c3.7-8.5,7-15.6,7-15.6S325.8,368.2,324,365.7z M313.8,398.2c-5.9,4-12.3,5.3-12.3,5.3 s-6.9-1.4-12.8-5.3s-12.5-14.9-12.5-14.9l11.5-8c1.2-2,13.6-0.4,13.6-0.4s12-2,13.6,0.4l11.5,8C326.9,383.3,319.6,394.4,313.8,398.2 z"></path>
                        </g>
                    </g>

                    <!-- NOS -->
                    <path id="nos" fill="#E0BB91" d="M300,332.4c-17.7-0.3-28.8-18-28.8-18s2.8,12.5,5.5,15.6c4.2,5.2,9.7,12.5,23.2,12.5 c13.5,0,18.7-7.3,23.2-12.5c2.8-3.1,5.5-15.6,5.5-15.6S317.7,332,300,332.4z"></path>

                    <!-- OƒåI -->
                    <g id="eyes">
                        <!-- LEV√â OKO -->
                        <g id="eye-l">
                            <path id="belmo-l" style="fill:#FFFFFF;" d="M220.7,240.5c0,0,5.5,7.6,6.9,7.6c1.4,0.3,10.7,3.8,13.2,3.8c2.4,0,18,0,20.8-0.7 c2.4-0.7,10.4-1.4,11.4-2.1c1-0.7,5.9-2.8,5.9-4.9c0-2.4,0.3-4.2,0-5.5s-3.1-4.9-4.9-5.5c-1.7-0.7-12.1-5.5-14.9-5.5 s-18.7-1-20.8-0.3c-2.1,0.7-5.5,0.7-7.6,1.7c-1.7,1-5.5,3.8-6.6,4.5c-1,0.7-2.4,2.1-2.8,2.8c-0.3,0.7-1,2.1-1,2.4 C220.7,239.5,220.7,240.5,220.7,240.5z"></path>
                            <!-- Duhovka o≈ô√≠znut√° bƒõlimou -->
                            <g clip-path="url(#clip-eye-left)">
                                <g id="iris-group-l" data-svg-origin="236.6999969482422 227.10000610351562" transform="matrix(1,0,0,1,-0.0464,-0.4798)" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                                    <ellipse id="iris-l" style="fill:#235fff;" cx="247.4" cy="238.5" rx="10.7" ry="11.4"></ellipse>
                                    <ellipse id="pupil-l" cx="247.4" cy="238.5" rx="6.2" ry="6.9"></ellipse>
                                    <ellipse id="glare-l" style="fill: rgb(255, 255, 255); translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" cx="251.5" cy="234" rx="4.2" ry="3.1" data-svg-origin="247.3000030517578 230.89999389648438" transform="matrix(1,0,0,1,0.0186,0.2399)"></ellipse>
                                </g>
                            </g>
                            <!-- V√≠ƒçka -->
                            <path id="lid-up-l" style="fill: rgb(224, 187, 145); translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" d="M221,237.8c0,0,7.6-6.2,12.1-8.3c4.5-2.1,23.9-1.4,28.4,0s14.2,5.5,16.3,8.3 c2.1,2.4,4.2-1.4,4.2-1.4s-5.9-6.2-10.4-8s-8.3-3.1-13.5-3.1c-5.2,0-20.4-1.4-27,2.4c-6.6,3.8-9.7,5.5-10,7.3 C220.7,236,218.6,239.9,221,237.8z" data-svg-origin="219.86790466308594 225.04803466796875" transform="matrix(1,0,0,1,0,0)"></path>
                            <path id="lid-low-l" style="fill: rgb(224, 187, 145); translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" d="M221,237.8c0,0,3.5,11.8,22.9,12.1s27.4-1.4,31.5-3.1 c4.2-2.1,2.8-8.7,2.8-8.7l4.2-1.4c0,0,1.4,4.5,0,6.9s-3.1,5.2-6.6,6.9c-3.5,1.7-22.2,6.2-32.9,5.2s-21.5-10.7-22.5-11.8 c-0.7-1,0-4.9,0-4.9L221,237.8z" data-svg-origin="220.08888244628906 236.70001220703125" transform="matrix(1,0,0,1,0,0)"></path>
                        </g>

                        <!-- PRAV√â OKO -->
                        <g id="eye-r">
                            <path id="belmo-r" style="fill:#FFFFFF;" d="M379.7,240.5c0,0-5.5,7.6-6.9,7.6c-1.4,0.3-10.7,3.8-13.2,3.8c-2.4,0-18,0-20.8-0.7 c-2.4-0.7-10.4-1.4-11.4-2.1c-1-0.7-5.9-2.8-5.9-4.9c0-2.4-0.3-4.2,0-5.5c0.3-1.4,3.1-4.9,4.9-5.5c1.7-0.7,12.1-5.5,14.9-5.5 s18.7-1,20.8-0.3c2.1,0.7,5.5,0.7,7.6,1.7c1.7,1,5.5,3.8,6.6,4.5s2.4,2.1,2.8,2.8c0.3,0.7,1,2.1,1,2.4S379.7,240.5,379.7,240.5z"></path>
                            <g clip-path="url(#clip-eye-right)">
                                <g id="iris-group-r" data-svg-origin="342.3999938964844 227.10000610351562" transform="matrix(1,0,0,1,-0.0464,-0.4798)" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                                    <ellipse id="iris-r" style="fill:#235fff;" cx="353.1" cy="238.5" rx="10.7" ry="11.4"></ellipse>
                                    <ellipse id="pupil-r" cx="353.1" cy="238.5" rx="6.2" ry="6.9"></ellipse>
                                    <ellipse id="glare-r" style="fill: rgb(255, 255, 255); translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" cx="357.6" cy="234" rx="4.2" ry="3.1" data-svg-origin="353.3999938964844 230.89999389648438" transform="matrix(1,0,0,1,0.0186,0.2399)"></ellipse>
                                </g>
                            </g>
                            <path id="lid-up-r" style="fill: rgb(224, 187, 145); translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" d="M379.4,237.8c0,0-7.6-6.2-12.1-8.3c-4.5-2.1-23.9-1.4-28.4,0s-14.2,5.5-16.3,8.3 c-2.1,2.4-4.2-1.4-4.2-1.4s5.9-6.2,10.4-8s8.3-3.1,13.5-3.1s20.4-1.4,27,2.4c6.6,3.8,9.7,5.5,10,7.3 C379.7,236,381.5,239.9,379.4,237.8z" data-svg-origin="318.3999938964844 225.04803466796875" transform="matrix(1,0,0,1,0,0)"></path>
                            <path id="lid-low-r" style="fill: rgb(224, 187, 145); translate: none; rotate: none; scale: none; transform-origin: 0px 0px;" d="M379.4,237.8c0,0-3.5,11.8-22.9,12.1s-27.4-1.4-31.5-3.1 c-4.2-2.1-2.8-8.7-2.8-8.7l-4.2-1.4c0,0-1.4,4.5,0,6.9s3.1,5.2,6.6,6.9c3.5,1.7,22.2,6.2,32.9,5.2c10.7-1,21.5-10.7,22.5-11.8 c0.7-1,0-4.9,0-4.9L379.4,237.8z" data-svg-origin="317.3777770996094 236.70001220703125" transform="matrix(1,0,0,1,0,0)"></path>
                        </g>
                    </g>
                </g>

                <!-- BR√ùLE (Parallax vrstva) -->
                <g id="glasses-group" data-svg-origin="181 198.5" transform="matrix(1,0,0,1,-0.0557,-0.5998)" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                    <path id="obroucka" fill="#3F3F3F" d="M407.8,204c-2.9-0.5-22.7-5.5-43.1-5.5s-39,4.7-47.3,7.7c-8.3,2.9-18.5,2.5-18.5,2.5 s-10.2,0.4-18.5-2.5s-27-7.7-47.3-7.7s-40.1,5-43.1,5.5c-2.9,0.5-9,1.6-9,1.6l0.6,17.2c0,0,3.7,0.2,5.3,3.9 c1.4,3.3,2,57.2,49.3,57.2s49.7-37.8,51.9-47.3c2-8.8,6.4-13.7,10.7-13.7s8.7,4.9,10.7,13.7c2.2,9.5,4.5,47.3,51.9,47.3 s47.9-54,49.3-57.2c1.6-3.8,5.3-3.9,5.3-3.9l0.6-17.2C416.7,205.6,410.7,204.6,407.8,204z M238.2,279.3 c-33.7,0-46.5-30.4-41.5-60.8c0,0,3.5-15.8,40.7-15c37.1,0.8,44.1,8.8,44.4,28.6S272.3,279.3,238.2,279.3z M359.6,279.3 c-34.1,0-43.9-27.4-43.6-47.2s7.3-27.8,44.4-28.6s40.7,15,40.7,15C406.2,249,393.3,279.3,359.6,279.3z"></path>
                    <use href="#obroucka" id="obroucka-glint" fill="url(#frameGlint)" opacity="0" style="mix-blend-mode: screen;"></use>
                    <path id="sklo-l" fill="url(#cool)" d="M196.7,218.5c0,0,3.5-15.8,40.7-15c37.1,0.8,44.1,8.8,44.4,28.6s-9.5,47.2-43.6,47.2 C204.5,279.3,191.7,249,196.7,218.5z"></path>
                    <path id="sklo-r" fill="url(#cool)" d="M401.1,218.5c0,0-3.5-15.8-40.7-15c-37.1,0.8-44.1,8.8-44.4,28.6s9.5,47.2,43.6,47.2 C393.3,279.3,406.2,249,401.1,218.5z"></path>
                </g>

            </g> <!-- Konec HEAD -->

            <!-- RUCE (P≈ôid√°ny v jednoduch√©m stylu jako triƒçko) -->
            <g id="hands-group" transform="matrix(1,0,0,1,0,53.9311)" data-svg-origin="-50 614.2857055664062" style="translate: none; rotate: none; scale: none; transform-origin: 0px 0px;">
                <path d="M-50,650 Q150,600 300,620 Q450,600 650,650 V800 H-50 Z" fill="#143045"></path>
                <!-- K≈Ø≈æe rukou -->
                <path d="M150,650 C180,630 250,640 290,660" fill="none" stroke="#E0BB91" stroke-linecap="round" stroke-width="40"></path>
                <path d="M450,650 C420,630 330,640 310,660" fill="none" stroke="#E0BB91" stroke-linecap="round" stroke-width="40"></path>
            </g>

        </g>
    </svg>
  </div>

</body>
</html>
