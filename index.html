<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSA</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

</head>

<body>
  <div class="wrap">
    <div class="tabs"></div>
    <!-- Statick√© ovl√°dac√≠ prvky pro nahr√°v√°n√≠ -->
    <div id="controls">
      <button id="start-recording">
        <svg version="1.1" viewBox="0 0 210 290" xmlns="http://www.w3.org/2000/svg">
          <g transform="translate(0 4.174)">
            <path d="m46.2 87.43c-6.23 0-11.28 4.842-11.28 10.82 0 31.98 
                 24.8 58.5 57.06 64.21v26.81h.047a13.02 12.75 0 00-.046.622 
                 13.02 12.75 0 0013.02 12.75 13.02 12.75 0 0013.02-12.75 
                 13.02 12.75 0 00-.016-.622h.016v-26.81c32.27-5.716 
                 57.07-32.23 57.06-64.21 0-5.973-5.05-10.82-11.28-10.82s-11.28 
                 4.842-11.28 10.82c0 24.09-20.95 43.74-47.52 43.74s-47.52-19.65-47.52-43.74
                 c0-5.973-5.05-10.82-11.28-10.82z" />
            <ellipse cx="92.74" cy="205.8" rx=".757" ry=".076" />
          </g>
          <path d="m105 0c-17.49 0-32.36 10.78-38.38 26.07h52.21c2.77 0 
               5 1.973 5 4.425 0 2.451-2.23 4.425-5 4.425h-54.61a41.91 
               41.91 0 00-.482 6.344v.68h55.09c2.77 0 5 1.974 5 4.426 
               0 2.451-2.23 4.425-5 4.425h-55.09v7.025h55.09c2.77 0 
               5 1.973 5 4.425 0 2.451-2.23 4.425-5 4.425h-55.09v29.24c0 
               22.86 18.4 41.26 41.26 41.26s41.26-18.4 41.26-41.26v-54.65c0-22.86-18.4-41.26-41.26-41.26z"
            stroke-linecap="round" stroke-miterlimit="4.1" paint-order="markers fill stroke" />
          <text   xml:space="preserve">
            <tspan x="0" y="270" style="font-size:4rem;stroke-width:.786">TEXT</tspan>
          </text>
        </svg>
       </button>
      <button id="start-sound-capture">
        <!-- SVG z√°znam zvuku -->
        <svg version="1.1" viewBox="0 0 210 290"  xmlns="http://www.w3.org/2000/svg">
          <g transform="translate(0 4.174)">
            <path d="m46.2 87.43c-6.23 0-11.28 4.842-11.28 10.82 0 31.98 
                 24.8 58.5 57.06 64.21v26.81h.047a13.02 12.75 0 00-.046.622 
                 13.02 12.75 0 0013.02 12.75 13.02 12.75 0 0013.02-12.75 
                 13.02 12.75 0 00-.016-.622h.016v-26.81c32.27-5.716 
                 57.07-32.23 57.06-64.21 0-5.973-5.05-10.82-11.28-10.82s-11.28 
                 4.842-11.28 10.82c0 24.09-20.95 43.74-47.52 43.74s-47.52-19.65-47.52-43.74
                 c0-5.973-5.05-10.82-11.28-10.82z" />
            <ellipse cx="92.74" cy="205.8" rx=".757" ry=".076" />
          </g>
          <path d="m105 0c-17.49 0-32.36 10.78-38.38 26.07h52.21c2.77 0 
               5 1.973 5 4.425 0 2.451-2.23 4.425-5 4.425h-54.61a41.91 
               41.91 0 00-.482 6.344v.68h55.09c2.77 0 5 1.974 5 4.426 
               0 2.451-2.23 4.425-5 4.425h-55.09v7.025h55.09c2.77 0 
               5 1.973 5 4.425 0 2.451-2.23 4.425-5 4.425h-55.09v29.24c0 
               22.86 18.4 41.26 41.26 41.26s41.26-18.4 41.26-41.26v-54.65c0-22.86-18.4-41.26-41.26-41.26z"
            stroke-linecap="round" stroke-miterlimit="4.1" paint-order="markers fill stroke" />
            <text   xml:space="preserve">
              <tspan x="0" y="270" style="font-size:4rem;stroke-width:.786">ZVUK</tspan>
            </text>
        </svg>
      </button>
      <button id="import-tab" title="Import">
        <span class="material-icons">file_upload</span>
        Import
      </button>
      <button id="export-tab" title="Export">
        <span class="material-icons">file_download</span>
        Export
      </button>
      <button id="delete-tab" title="Smazat tab">
        <span class="material-icons">delete</span>
        Smazat
      </button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
  <script>
 // SSA Application JavaScript
window.addEventListener('DOMContentLoaded', () => {
  // Dynamick√© naƒçten√≠ annyang
  function initAnnyang() {
    if (!window.annyang) return;
    annyang.setLanguage('cs-CZ');
    annyang.addCommands({
      '*text': txt => {
        const id = document.querySelector('.tab-button.active').dataset.tab;
        const body = document.querySelector(`#${id} .tab-content-body`);
        addTextButton(txt, body, id, id === 'predefined');
        tabsData[id] = tabsData[id] || [];
        tabsData[id].push(txt);
        persist();
        annyang.abort();
        recBtn.classList.remove('active');
      }
    });
    annyang.addCallback('end', () => recBtn.classList.remove('active'));
  }
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js';
  script.onload = initAnnyang;
  script.onerror = () => console.warn('annyang se nepoda≈ôilo naƒç√≠st');
  document.head.appendChild(script);

  // Glob√°ln√≠ reference
  const wrap = document.querySelector('.wrap');
  const tabsContainer = document.querySelector('.tabs');
  const recBtn = document.getElementById('start-recording');
  const soundBtn = document.getElementById('start-sound-capture');
  const impBtn = document.getElementById('import-tab');
  const expBtn = document.getElementById('export-tab');
  const delBtn = document.getElementById('delete-tab');

  // Stav a data
  let isPlaying = false, isRecording = false;
  let isSoundRecording = false; // flag for audio recording
  let mediaRecorder, audioChunks = [], audioStartTime;
  const customTabs = JSON.parse(localStorage.getItem('customTabs') || '[]');
  const tabsData = JSON.parse(localStorage.getItem('tabsData') || '{}');
  let keyHandlers = [];

  function persist() {
    localStorage.setItem('customTabs', JSON.stringify(customTabs));
    localStorage.setItem('tabsData', JSON.stringify(tabsData));
  }

  function speak(text, cb) {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'cs-CZ'; u.onend = cb;
    speechSynthesis.speak(u);
  }

  function resetShortcuts(container) {
    keyHandlers.forEach(h => document.removeEventListener('keydown', h)); keyHandlers = [];
    container.querySelectorAll('.text-button').forEach((btn, i) => {
      const letter = 'abcdefghijklmnopqrstuvwxyz'[i];
      if (!letter) return;
      let span = btn.querySelector('.shortcut') || document.createElement('span');
      span.className = 'shortcut';
      span.textContent = letter.toUpperCase();
      btn.appendChild(span);
      const handler = e => (e.key === letter) && btn.click();
      document.addEventListener('keydown', handler);
      keyHandlers.push(handler);
    });
  }

  function addTextButton(text, container, tabId, isPredef = false) {
    const wrapper = document.createElement('div'); wrapper.className = 'transcription-button';
    const btn = document.createElement('button'); btn.className = 'text-button'; btn.textContent = text;
    btn.addEventListener('click', () => {
      if (!isPlaying) { isPlaying = true; speak(text, () => isPlaying = false); }
    });
    const edit = document.createElement('button'); edit.className = 'edit-button'; edit.textContent = '‚úèÔ∏è';
    edit.addEventListener('click', () => {
      const nt = prompt('Upravit text:', text); if (!nt) return;
      btn.textContent = nt;
      if (!isPredef) { tabsData[tabId] = tabsData[tabId].map(t => t === text ? nt : t); persist(); }
      resetShortcuts(container);
    });
    const del = document.createElement('button'); del.className = 'delete-button'; del.textContent = 'üóëÔ∏è';
    del.addEventListener('click', () => {
      wrapper.remove(); if (!isPredef) { tabsData[tabId] = tabsData[tabId].filter(t => t !== text); persist(); }
      resetShortcuts(container);
    });
    wrapper.append(del, btn, edit);
    container.appendChild(wrapper);
    resetShortcuts(container);
  }

  function createTab(id, name, isPredef = false) {
    const btn = document.createElement('button'); btn.className = 'tab-button'; btn.dataset.tab = id; btn.textContent = name;
    tabsContainer.appendChild(btn);
    const tabDiv = document.createElement('div'); tabDiv.className = 'tab-content'; tabDiv.id = id;
    const body = document.createElement('div'); body.className = 'tab-content-body'; tabDiv.appendChild(body); wrap.appendChild(tabDiv);
    const arr = tabsData[id] || (isPredef ? ['√öplnƒõ c√≠t√≠m jak ti v n√≠ cuk√°','Je≈æi≈°i','Poƒçkej'] : []);
    arr.forEach(t => addTextButton(t, body, id, isPredef));
  }

  function activateTab(id) {
        // Reset recording state when switching tabs
        if (isRecording) {
          window.annyang && annyang.abort();
          recBtn.classList.remove('active');
          isRecording = false;
        }
        document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === id));
    localStorage.setItem('activeTab', id);
    const body = document.querySelector(`#${id} .tab-content-body`);
    if (body) resetShortcuts(body);
  }

  // P≈ôep√≠n√°n√≠ z√°lo≈æek
  tabsContainer.addEventListener('click', e => { if (e.target.matches('.tab-button')) activateTab(e.target.dataset.tab); });
  document.addEventListener('keydown', e => {
    if (e.shiftKey && /^[1-9]$/.test(e.key)) {
      const idx = parseInt(e.key, 10) - 1;
      const btns = Array.from(document.querySelectorAll('.tab-button'));
      if (btns[idx]) activateTab(btns[idx].dataset.tab);
    }
  });

  // Inicializace tab≈Ø
  createTab('user','Vlastn√≠',false);
  createTab('predefined','P≈ôeddefinovan√©',true);
  customTabs.forEach(t => createTab(t.id, t.name, false));
  const plusBtn = document.createElement('button'); plusBtn.className = 'add-tab-button'; plusBtn.textContent = '+';
  plusBtn.addEventListener('click', () => {
    const name = prompt('N√°zev nov√©ho tabu:'); if (!name) return;
    const id = 'tab-' + Date.now(); customTabs.push({id,name}); tabsData[id] = [];
    persist(); createTab(id,name,false); activateTab(id);
  }); tabsContainer.appendChild(plusBtn);
  activateTab(localStorage.getItem('activeTab') || 'user');

  // Import
  impBtn.addEventListener('click', () => {
    const id = document.querySelector('.tab-button.active').dataset.tab;
    const json = prompt('Vlo≈æ JSON:');
    try {
      tabsData[id] = JSON.parse(json);
      persist();
      const body = document.querySelector(`#${id} .tab-content-body`);
      body.innerHTML = '';
      tabsData[id].forEach(t => addTextButton(t, body, id, id === 'predefined'));
    } catch {
      alert('Neplatn√© JSON');
    }
  });

  // Export
  expBtn.addEventListener('click', () => {
    const id = document.querySelector('.tab-button.active').dataset.tab;
    const arr = Array.from(document.querySelectorAll(`#${id} .text-button`)).map(b => b.textContent);
    prompt('Kop√≠ruj JSON:', JSON.stringify(arr));
  });

  // Delete
  delBtn.addEventListener('click', () => {
    const id = document.querySelector('.tab-button.active').dataset.tab;
    if (id === 'user' || id === 'predefined') return;
    if (!confirm('Opravdu smazat tento tab?')) return;
    delete tabsData[id];
    const idx = customTabs.findIndex(t => t.id === id);
    if (idx !== -1) customTabs.splice(idx, 1);
    persist();
    document.querySelector(`.tab-button[data-tab="${id}"]`).remove();
    document.getElementById(id).remove();
    activateTab('user');
  });

    // Ovl√°dac√≠ diktov√°n√≠ (annyang)
  recBtn.addEventListener('click', () => {
    if (isRecording) {
      window.annyang && annyang.abort();
      recBtn.classList.remove('active');
    } else {
      window.annyang && annyang.start({autoRestart:false,continuous:false});
      recBtn.classList.add('active');
    }
    isRecording = !isRecording;
  });

  // Ovl√°dac√≠ nahr√°v√°n√≠ zvuku
  soundBtn.addEventListener('click', () => {
    const id = document.querySelector('.tab-button.active').dataset.tab;
    const body = document.querySelector(`#${id} .tab-content-body`);
    if (isSoundRecording) {
      mediaRecorder.stop();
      soundBtn.classList.remove('active');
      isSoundRecording = false;
    } else {
      navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        audioStartTime = Date.now();
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks,{type:'audio/wav'});
          const url = URL.createObjectURL(blob);
          const dur = ((Date.now()-audioStartTime)/1000).toFixed(1);
          const wrapper = document.createElement('div'); wrapper.className='transcription-button';
          const play = document.createElement('button'); play.className='edit-button'; play.textContent='‚ñ∂Ô∏è'; play.onclick=()=>new Audio(url).play();
          const lbl = document.createElement('button'); lbl.className='text-button'; lbl.textContent=`Raw Audio (${dur}s)`;
          const del = document.createElement('button'); del.className='delete-button'; del.textContent='üóëÔ∏è'; del.onclick=()=>wrapper.remove();
          wrapper.append(del,lbl,play); body.append(wrapper); resetShortcuts(body);
        };
        mediaRecorder.start();
        soundBtn.classList.add('active');
        isSoundRecording = true;
      });
    }
  });

});


  </script>
</body>

</html>