<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SSA</title>
  <style>
    body {
      font-family: sans-serif;
    }

    .wrap {
      padding: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .tab-button {
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      background: #eee;
      border-radius: 5px;
    }

    .tab-button.active {
      background: #ccc;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .transcription-button {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .text-button {
      padding: 6px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 4px;
      flex-grow: 1;
      text-align: left;
    }

    .edit-button, .delete-button {
      cursor: pointer;
      background: transparent;
      border: none;
      font-size: 18px;
    }

    .shortcut {
      margin-left: 10px;
      color: gray;
    }

    .panel {
      margin-bottom: 20px;
    }

    .record-button {
      padding: 10px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
    }

    .record-button.active {
      background-color: red;
      color: white;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <button id="start-recording" class="record-button">üéôÔ∏è Hlas</button>
      <button id="start-sound-capture" class="record-button">üî¥ Zvuk</button>
    </div>

    <div class="tabs">
      <button class="tab-button active" data-tab="predefined">P≈ôeddefinovan√©</button>
      <button class="tab-button" data-tab="user">Vlastn√≠</button>
    </div>

    <div class="tab-content active" id="predefined"></div>
    <div class="tab-content" id="user"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const predefinedContainer = document.getElementById("predefined");
      const userContainer = document.getElementById("user");
      const startRecordingButton = document.getElementById("start-recording");
      const startSoundCaptureButton = document.getElementById("start-sound-capture");

      const shortcuts = "abcdefghijklmnopqrstuvwxyz".split("");
      let isPlaying = false;
      let hasSpoken = false;
      let isRecording = false;
      let mediaRecorder;
      let audioChunks = [];
      let audioStartTime;

      document.querySelectorAll(".tab-button").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(tc => tc.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(btn.dataset.tab).classList.add("active");
        });
      });

      const readTextAloud = (text, callback) => {
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = 'cs-CZ';
        utterThis.onend = callback;
        window.speechSynthesis.speak(utterThis);
      };

      const createTranscriptionButton = (text, container = userContainer, isPredefined = false) => {
        const buttonWrapper = document.createElement("div");
        buttonWrapper.className = "transcription-button";

        const button = document.createElement("button");
        button.className = "text-button";
        button.textContent = text;

        const shortcut = shortcuts.shift();
        if (shortcut) {
          const shortcutSpan = document.createElement("span");
          shortcutSpan.className = "shortcut";
          shortcutSpan.textContent = shortcut.toUpperCase();
          button.appendChild(shortcutSpan);

          document.addEventListener("keydown", (event) => {
            if (event.key === shortcut) {
              button.click();
              buttonWrapper.classList.toggle('active');
            }
          });
        }

        button.addEventListener("click", () => {
          if (!isPlaying && !hasSpoken) {
            isPlaying = true;
            hasSpoken = true;
            readTextAloud(text, () => {
              isPlaying = false;
              hasSpoken = false;
            });
          }
        });

        const editButton = document.createElement("button");
        editButton.className = "edit-button";
        editButton.innerHTML = "‚úèÔ∏è";
        editButton.addEventListener("click", () => {
          const newText = prompt("Upravit text:", text);
          if (newText) {
            button.textContent = newText;
            if (!isPredefined) updateTranscription(text, newText);
          }
        });

        const deleteButton = document.createElement("button");
        deleteButton.className = "delete-button";
        deleteButton.innerHTML = "üóëÔ∏è";
        deleteButton.addEventListener("click", () => {
          buttonWrapper.remove();
          if (!isPredefined) deleteTranscription(text);
        });

        buttonWrapper.appendChild(deleteButton);
        buttonWrapper.appendChild(button);
        buttonWrapper.appendChild(editButton);
        container.appendChild(buttonWrapper);
      };

      const saveTranscription = (text) => {
        let stored = JSON.parse(localStorage.getItem("transcriptions")) || [];
        stored.push(text);
        localStorage.setItem("transcriptions", JSON.stringify(stored));
      };

      const updateTranscription = (oldText, newText) => {
        let stored = JSON.parse(localStorage.getItem("transcriptions")) || [];
        const index = stored.indexOf(oldText);
        if (index !== -1) {
          stored[index] = newText;
          localStorage.setItem("transcriptions", JSON.stringify(stored));
        }
      };

      const deleteTranscription = (text) => {
        let stored = JSON.parse(localStorage.getItem("transcriptions")) || [];
        stored = stored.filter(t => t !== text);
        localStorage.setItem("transcriptions", JSON.stringify(stored));
      };

      const loadTranscriptions = () => {
        const stored = JSON.parse(localStorage.getItem("transcriptions")) || [];
        stored.forEach(text => createTranscriptionButton(text, userContainer));
      };

      const predefined = [
        "Dobr√Ω den",
        "Jak v√°m mohu pomoci?",
        "Pros√≠m, ≈ôeknƒõte nƒõco.",
        "Dƒõkuji, nashledanou.",
        "Zkuste to znovu."
      ];
      predefined.forEach(text => createTranscriptionButton(text, predefinedContainer, true));
      loadTranscriptions();

      // Speech Recognition (annyang)
      if (annyang) {
        const commands = {
          '*text': (text) => {
            createTranscriptionButton(text, userContainer);
            saveTranscription(text);
          }
        };
        annyang.addCommands(commands);
        annyang.setLanguage('cs-CZ');

        const toggleRecording = () => {
          if (isRecording) {
            annyang.abort();
            startRecordingButton.classList.remove('active');
          } else {
            annyang.start();
            startRecordingButton.classList.add('active');
          }
          isRecording = !isRecording;
        };

        startRecordingButton.addEventListener("click", toggleRecording);
        document.addEventListener("keydown", (event) => {
          if (event.key === "Control") {
            toggleRecording();
          }
        });

        annyang.addCallback('end', () => {
          if (isRecording) toggleRecording();
        });

        annyang.addCallback('error', (event) => {
          console.error("Speech recognition error", event.error);
        });
      }

      // Audio capture
      startSoundCaptureButton.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          startSoundCaptureButton.classList.remove("active");
        } else {
          navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioStartTime = Date.now();
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              const audioUrl = URL.createObjectURL(audioBlob);
              const duration = (Date.now() - audioStartTime) / 1000;

              const buttonWrapper = document.createElement("div");
              buttonWrapper.className = "transcription-button";

              const playButton = document.createElement("button");
              playButton.className = "edit-button";
              playButton.innerHTML = "‚ñ∂Ô∏è";
              playButton.addEventListener("click", () => {
                const audio = new Audio(audioUrl);
                audio.play();
              });

              const label = document.createElement("button");
              label.textContent = `Raw Audio (${duration.toFixed(2)}s)`;
              label.className = "text-button";

              const deleteButton = document.createElement("button");
              deleteButton.className = "delete-button";
              deleteButton.innerHTML = "üóëÔ∏è";
              deleteButton.addEventListener("click", () => {
                buttonWrapper.remove();
              });

              buttonWrapper.appendChild(deleteButton);
              buttonWrapper.appendChild(label);
              buttonWrapper.appendChild(playButton);
              userContainer.appendChild(buttonWrapper);
            };

            mediaRecorder.start();
            startSoundCaptureButton.classList.add("active");
          }).catch(err => {
            console.error("Microphone error: ", err);
          });
        }
      });
    });
  </script>
</body>
</html>
