<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAT</title>
    <link crossorigin="anonymous" rel="icon" href="fav.svg" sizes="32x32">
    <style>
        body {
            padding: 0px;
            margin: 0px;
            width: 100%;
            overflow: hidden;
        }
        .wrap {
            padding: 10px;
        }
        button {
            display: inline-block;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            color: #333;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }
        button:hover {
            color: red;
        }
        .grid-container {
            display: flex;
            justify-items: stretch;
            flex-direction: row;
            width: auto;
            padding-top: 20px;
            justify-content: flex-start;
            align-content: center;
            flex-wrap: wrap;
            border-top-left-radius: 0px;
        }
        .transcription-button {
            position: relative;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        button.text-button {
            border: 0px solid #ccc;
            background-color: #ffffff;
        }
        .edit-button {
            border-left: 1px solid #ccc;
            background-color: transparent;
            cursor: pointer;
            color: #333;
            font-size: 16px;
            padding: 2px;
        }
        .delete-button {
            border-right: 1px solid #ccc;
            background-color: transparent;
            cursor: pointer;
            color: #333;
            font-size: 16px;
            padding: 2px;
        }
        #start-recording, #start-sound-capture {
            padding: 10px;
            border: 1px solid #ccc;
            background-color: transparent;
            border-radius: 100%;
            transform: translateY(1px);
        }
        #start-recording.active, #start-sound-capture.active {
            border: 1px solid red;
            box-shadow: 0px 0px 7px 0px rgba(255, 0, 0, 0.3);
            padding: 10px;
        }
        #start-recording.active, #start-sound-capture.active {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0px 0px 20px red;
            }
            50% {
                box-shadow: 0px 0px 40px red;
            }
            100% {
                box-shadow: 0px 0px 20px red;
            }
        }
        .shortcut {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 12px;
            color: black;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .tooltip {
            position: absolute;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 5px;
            font-size: 12px;
            visibility: hidden;
            z-index: 1;
            top: -25px;
        }
        .transcription-button:hover .tooltip {
            visibility: visible;
        }
        button.active {
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <button id="start-recording">Mic</button>
        <button id="start-sound-capture">Pure Sound</button>
        <br>
        <div id="transcriptions" class="grid-container"></div>
    </div>

       <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
       <script>
        const synth = window.speechSynthesis;
        const shortcuts = "abcdefghijklmnopqrstuvwxyz".split("");
        let isRecording = false;
        let isPlaying = false;
        document.addEventListener("DOMContentLoaded", () => {
    const startSoundCaptureButton = document.getElementById("start-sound-capture");
    const transcriptionsContainer = document.getElementById("transcriptions");
    let mediaRecorder;
    let audioChunks = [];
    let audioStartTime;

    startSoundCaptureButton.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            startSoundCaptureButton.classList.remove('active');
        } else {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioStartTime = Date.now();

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audioDuration = (Date.now() - audioStartTime) / 1000;
                        createAudioButton(audioUrl, audioDuration);
                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    startSoundCaptureButton.classList.add('active');
                })
                .catch(error => {
                    console.error("Error accessing microphone: ", error);
                });
        }
    });

    const createAudioButton = (audioUrl, duration) => {
        const buttonWrapper = document.createElement("div");
        buttonWrapper.className = "transcription-button";

        const button = document.createElement("button");
        button.className = "text-button";
        button.innerHTML = "&#9654;"; // Triangle icon for play
        button.addEventListener("click", () => {
            const audio = new Audio(audioUrl);
            audio.play();
        });

        const info = document.createElement("span");
        info.textContent = `Raw Audio (${duration.toFixed(2)}s)`;

        const deleteButton = document.createElement("button");
        deleteButton.className = "delete-button";
        deleteButton.innerHTML = "ðŸ—‘ï¸";
        deleteButton.addEventListener("click", () => {
            buttonWrapper.remove();
        });

        buttonWrapper.appendChild(button);
        buttonWrapper.appendChild(info);
        buttonWrapper.appendChild(deleteButton);
        transcriptionsContainer.appendChild(buttonWrapper);
    };
});
        document.addEventListener("DOMContentLoaded", () => {
            const startRecordingButton = document.getElementById("start-recording");
            const transcriptionsContainer = document.getElementById("transcriptions");
        
            // Load transcriptions from local storage on page load
            const loadTranscriptions = () => {
                const storedTranscriptions = JSON.parse(localStorage.getItem("transcriptions")) || [];
                storedTranscriptions.forEach(transcription => {
                    createTranscriptionButton(transcription);
                });
            };
        
            // Create a button for each transcription
            const createTranscriptionButton = (text) => {
                const buttonWrapper = document.createElement("div");
                buttonWrapper.className = "transcription-button";
        
                const button = document.createElement("button");
                button.className = "text-button";
                button.textContent = text;
                button.addEventListener("click", () => {
                    if (!isPlaying) {
                        isPlaying = true;
                        readTextAloud(text);
                    }
                });
        
                const shortcut = shortcuts.shift();
                if (shortcut) {
                    const shortcutSpan = document.createElement("span");
                    shortcutSpan.className = "shortcut";
                    shortcutSpan.textContent = shortcut.toUpperCase();
                    button.appendChild(shortcutSpan);
        
                    document.addEventListener("keydown", (event) => {
                        if (event.key === shortcut) {
                            button.click();
                            button.classList.toggle('active');
                        }
                    });
                }
        
                const tooltip = document.createElement("span");
                tooltip.className = "tooltip";
                tooltip.textContent = `Press ${shortcut.toUpperCase()} to activate`;
                buttonWrapper.appendChild(tooltip);
        
                const editButton = document.createElement("button");
                editButton.className = "edit-button";
                editButton.innerHTML = "âœï¸";
                editButton.addEventListener("click", () => {
                    const newText = prompt("Edit transcription:", text);
                    if (newText) {
                        button.textContent = newText;
                        updateTranscription(text, newText);
                        text = newText;
                    }
                });
        
                const deleteButton = document.createElement("button");
                deleteButton.className = "delete-button";
                deleteButton.innerHTML = "ðŸ—‘ï¸";
                deleteButton.addEventListener("click", () => {
                    buttonWrapper.remove();
                    deleteTranscription(text);
                });
        
                buttonWrapper.appendChild(deleteButton);
                buttonWrapper.appendChild(button);
                
                buttonWrapper.appendChild(editButton);
                transcriptionsContainer.appendChild(buttonWrapper);
            };
        
            // Save transcriptions to local storage
            const saveTranscription = (text) => {
                let storedTranscriptions = JSON.parse(localStorage.getItem("transcriptions")) || [];
                storedTranscriptions.push(text);
                localStorage.setItem("transcriptions", JSON.stringify(storedTranscriptions));
            };
        
            // Update transcription in local storage
            const updateTranscription = (oldText, newText) => {
                let storedTranscriptions = JSON.parse(localStorage.getItem("transcriptions")) || [];
                const index = storedTranscriptions.indexOf(oldText);
                if (index !== -1) {
                    storedTranscriptions[index] = newText;
                    localStorage.setItem("transcriptions", JSON.stringify(storedTranscriptions));
                }
            };
        
            // Delete transcription from local storage
            const deleteTranscription = (text) => {
                let storedTranscriptions = JSON.parse(localStorage.getItem("transcriptions")) || [];
                storedTranscriptions = storedTranscriptions.filter(transcription => transcription !== text);
                localStorage.setItem("transcriptions", JSON.stringify(storedTranscriptions));
            };
        
            // Annyang setup for speech recognition
            
    // Annyang setup for speech recognition
    if (annyang) {
        const commands = {
            '*text': (text) => {
                createTranscriptionButton(text);
                saveTranscription(text);
            }
        };

        annyang.addCommands(commands);
        annyang.setLanguage('cs-CZ'); // Set language to Czech


        
function recording () {
    if (!isRecording) {
                annyang.start();
                startRecordingButton.classList.toggle('active');
                isRecording = true;
                setTimeout(() => {
                    annyang.abort();
                     startRecordingButton.classList.toggle('active');
                 }, 5000); // Stop recording after 5 seconds
            } 
    else {
                annyang.abort();                 
                
    }
}
        startRecordingButton.addEventListener("click", () => {
            
                recording();
            
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Control") {
                  
              recording();
            
            }
        });

        annyang.addCallback('end', () => {
            isRecording = true;
          recording();  
        });

        annyang.addCallback('error', (event) => {
            console.error("Speech recognition error", event.error);
            

        });
    } else {
        console.log("Annyang is not supported in this browser.");
    }
            const readTextAloud = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'cs-CZ'; // Set language to Czech
        
                // Randomly change speed and voice
                utterance.rate = Math.random() * (1.5 - 0.5) + 0.5;
                const voices = synth.getVoices().filter(voice => voice.lang === 'cs-CZ');
                if (voices.length > 0) {
                    const randomVoice = voices[Math.floor(Math.random() * voices.length)];
                    utterance.voice = randomVoice;
                }
        
                utterance.onend = () => {
                    isPlaying = false;
                };
                speechSynthesis.speak(utterance);
            };
        
            loadTranscriptions();
        });        
    </script>
</body>
</html>
